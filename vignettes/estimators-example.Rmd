---
title: "estimators-example"
output: html_document
vignette: >
  %\VignetteIndexEntry{estimators-example}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
library(tidyverse)
devtools::load_all()
# library(growthrates)
here::i_am("vignettes/estimators-example.Rmd")
source(here::here("vignettes/vignette-utils.R"))
ggplot2::theme_set(ggplot2::theme_minimal())
```

* TODO change .test_data to be a regular data frame and give example of the 
conversion to the timeseries.
* have a date based data frame as input.

# Poisson model

* Absolute counts 

```{r}
data = .test_data()

tmp = data %>% dplyr::select(-r,-rate) %>% poisson_locfit_model(window=7, deg = 2)

ggplot(tmp,ggplot2::aes(x=time,y=incidence.0.5, ymin=incidence.0.025, ymax=incidence.0.975))+
  ggplot2::geom_line()+
  ggplot2::geom_ribbon(alpha=0.2)+
  ggplot2::geom_point(mapping=ggplot2::aes(x=time,y=count), data=data, colour="red",inherit.aes = FALSE)+
  ggplot2::geom_line(mapping=ggplot2::aes(x=time,y=rate), data=data, colour="red",inherit.aes = FALSE)
```

* Absolute growth rate

```{r}
ggplot(tmp,ggplot2::aes(x=time,y=growth.0.5, ymin=growth.0.025, ymax=growth.0.975))+
  ggplot2::geom_line()+ggplot2::geom_ribbon(alpha=0.2)+
  ggplot2::geom_line(mapping=ggplot2::aes(x=time,y=r), data=data, colour="red",inherit.aes = FALSE)
```

* Multiple classes absolute count

```{r}
data2 = .test_multinomial()
tmp2 = data2 %>% dplyr::select(-r,-rate) %>% dplyr::group_by(class) %>% dplyr::group_modify(poisson_locfit_model, window=7, deg = 1)

ggplot(tmp2,ggplot2::aes(x=time,y=incidence.0.5, ymin=incidence.0.025, ymax=incidence.0.975, colour=class, group=class))+
  ggplot2::geom_line()+
  ggplot2::geom_ribbon(alpha=0.2, color=NA)+
  ggplot2::geom_point(mapping=ggplot2::aes(x=time,y=count, color=class), data=data2,inherit.aes = FALSE)+
  scale_y_log1p()
```

* Multiple classes absolute growth rate

```{r}
ggplot(tmp2,ggplot2::aes(x=time,y=growth.0.5, ymin=growth.0.025, ymax=growth.0.975,colour=class,groups=class))+
  ggplot2::geom_line()+ggplot2::geom_ribbon(alpha=0.2, color=NA)+
  ggplot2::geom_line(mapping=ggplot2::aes(x=time,y=r, colour=class), data=data2,inherit.aes = FALSE)+ggplot2::facet_wrap(dplyr::vars(class), ncol=1)
```

# One versus others binomial model 

* Relative growth rate

```{r}

#devtools::load_all()

# This will reinterpret total to be the total of positives
tmp3 = data2 %>% 
  dplyr::group_by(time) %>% 
  dplyr::mutate(denom = sum(count)) %>%
  dplyr::group_by(class) %>% 
  dplyr::group_modify(proportion_locfit_model, window=14, deg = 2)



ggplot(tmp3,ggplot2::aes(x=time,y=relative.growth.0.5, ymin=relative.growth.0.025, ymax=relative.growth.0.975,colour=class,group=class))+
  ggplot2::geom_line()+
  ggplot2::geom_ribbon(alpha=0.2, color=NA)+
  ggplot2::geom_line(mapping=ggplot2::aes(x=time,y=relative.r, colour=class), data=data2, inherit.aes = FALSE)+
  ggplot2::facet_wrap(dplyr::vars(class), ncol=1)

```

* Absolute proportions

```{r}
ggplot(tmp3,ggplot2::aes(x=time,y=proportion.0.5, ymin=proportion.0.025, ymax=proportion.0.975,colour=class,group=class))+
  ggplot2::geom_point(mapping=ggplot2::aes(x=time,y=proportion.obs, colour=class), data=data2, inherit.aes = FALSE, size = 0.5)+
  ggplot2::geom_line()+
  ggplot2::geom_ribbon(alpha=0.2, color=NA)+
  ggplot2::facet_wrap(dplyr::vars(class), ncol=1)
```


# Multinomial model

* Absolute proportions only

```{r}

# we don;t need to calculate the denominator as it is done automatically by the 
tmp4 = data2 %>% multinomial_nnet_model()

ggplot(tmp4,ggplot2::aes(x=time,y=proportion.0.5, colour=class,group=class))+
  ggplot2::geom_point(mapping=ggplot2::aes(x=time,y=proportion.obs, colour=class), data=data2, inherit.aes = FALSE, size = 0.5)+
  ggplot2::geom_line()+
  ggplot2::facet_wrap(dplyr::vars(class), ncol=1)

```

# GLM poisson model

* Spline currently only good for incidence

```{r}

tmp5 = data %>% poisson_glm_model(window=7)

ggplot(tmp5,ggplot2::aes(x=time,y=incidence.0.5, ymin=incidence.0.025, ymax=incidence.0.975))+
  ggplot2::geom_line()+
  ggplot2::geom_ribbon(alpha=0.2)+
  ggplot2::geom_point(mapping=ggplot2::aes(x=time,y=count), data=data, colour="red",inherit.aes = FALSE)+
  ggplot2::geom_line(mapping=ggplot2::aes(x=time,y=rate), data=data, colour="red",inherit.aes = FALSE)
```

# GLM poisson model

* Absolute proportions only

```{r}

# we don;t need to calculate the denominator as it is done automatically by the 
tmp6 = data2 %>%
  dplyr::group_by(time) %>% 
  dplyr::mutate(denom = sum(count)) %>%
  dplyr::group_by(class) %>% 
  dplyr::group_modify(proportion_glm_model, window=14, deg = 2)

ggplot(tmp6,ggplot2::aes(x=time,y=proportion.0.5, colour=class,group=class))+
  ggplot2::geom_point(mapping=ggplot2::aes(x=time,y=proportion.obs, colour=class), data=data2, inherit.aes = FALSE, size = 0.5)+
  ggplot2::geom_line()+
  ggplot2::facet_wrap(dplyr::vars(class), ncol=1)

```
