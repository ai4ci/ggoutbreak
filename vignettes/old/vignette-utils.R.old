
# .test_data()
# ggplot(.test_data(),aes(x=date,y=count))+geom_point()+scale_y_continuous(trans="log1p")
.test_data = function(
    changes = tibble(time = c(0,20,40,60,80), r = c(0.1,0,-0.1,0,0.1)),
    initial = 100,
    duration = 100,
    seed=100
) {
  set.seed(seed)
  tibble(time = 0:duration) %>%
    left_join(changes, by="time") %>%
    fill(r) %>%
    mutate(rate = initial*exp(cumsum(r))) %>%
    mutate(
      count = rpois(n(),rate),
      total = max(count)*2
    ) %>% as.timeseries(
      days_in_period = 7, start_date="2020-01-01"
    )
}

# .test_multinomial()
.test_multinomial = function(
    changes = tibble(
      time = c(0,20,40,60,80),
      variant1 = c(0.1,0,-0.1,0,0.1),
      variant2 = c(0.15,0.05,-0.05,-0.01,0.05)
    ), initial=c(100,1), ...) {
  cols = setdiff(colnames(changes),"time")
  out = tibble()
  i = 1
  for (col in cols) {
    out = bind_rows(
      out,
      .test_data(changes = changes %>% select(time, r=!!col), initial=initial[[i]], ...) %>% mutate(class = col, time=as.numeric(time)) %>% as_tibble()
    )
  }

  out = out %>% as.timeseries(
    days_in_period = 7, start_date="2020-01-01"
  )

  return(out)
}


.download = function(url,filename) {
  download_dir = rappdirs::user_cache_dir("growthrates")
  if (!fs::dir_exists(download_dir)) fs::dir_create(download_dir)
  raw_lineages = fs::path(download_dir, filename)
  if (fs::file_exists(raw_lineages)) {
    tmp = fs::file_info(raw_lineages)
    if (tmp$change_time < as.POSIXct(Sys.Date()-7)) unlink(raw_lineages)
  }
  if (!fs::file_exists(raw_lineages)) {
    downloader::download(url,raw_lineages)
  }
  return(raw_lineages)
}
