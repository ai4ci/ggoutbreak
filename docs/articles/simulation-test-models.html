<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en-GB">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Simulations and test harnesses • ggoutbreak</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Simulations and test harnesses">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">ggoutbreak</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.4.3</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/covid-timeseries.html">England COVID-19 cases</a></li>
    <li><a class="dropdown-item" href="../articles/estimators-example.html">Simulation tests for growth rate estimators</a></li>
    <li><a class="dropdown-item" href="../articles/incidence-trends.html">Population comparisons and incidence</a></li>
    <li><a class="dropdown-item" href="../articles/infectivity-profile-discretisation.html">Infectivity profile discretisation</a></li>
    <li><a class="dropdown-item" href="../articles/rt-from-incidence.html">Estimating the reproduction number from modelled incidence</a></li>
    <li><a class="dropdown-item" href="../articles/sampling-serial-interval.html">Sampling the infectivity profile from published serial interval estimates</a></li>
    <li><a class="dropdown-item" href="../articles/simulation-test-models.html">Simulations and test harnesses</a></li>
    <li><a class="dropdown-item" href="../articles/time-periods.html">Data wrangling and working with `ggoutbreak`</a></li>
    <li><a class="dropdown-item" href="../articles/time-units.html">Estimating the reproduction number from weekly data</a></li>
    <li><a class="dropdown-item" href="../articles/variant-proportions.html">Multinomial proportions models for genomic variants</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/ai4ci/ggoutbreak/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Simulations and test harnesses</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/ai4ci/ggoutbreak/blob/HEAD/vignettes/simulation-test-models.Rmd" class="external-link"><code>vignettes/simulation-test-models.Rmd</code></a></small>
      <div class="d-none name"><code>simulation-test-models.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="background">Background<a class="anchor" aria-label="anchor" href="#background"></a>
</h2>
<p>Testing the inference of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>R</mi><mi>t</mi></msub><annotation encoding="application/x-tex">R_t</annotation></semantics></math>
and growth rate estimates needs a ground truth, which is missing in real
outbreaks as infection events cannot be truly observed. Testing accuracy
of estimates of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>R</mi><mi>t</mi></msub><annotation encoding="application/x-tex">R_t</annotation></semantics></math>
for example needs one or more simulations of outbreaks that have known
parametrisation. <code>ggoutbreak</code> contains some functions to
generate synthetic datasets which exhibit some of the complexities we
observed in the COVID-19 pandemic. There are two levels at which the
simulations work, aggregate counts or case line list simulations.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">knitr</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/knitr/man/opts_chunk.html" class="external-link">opts_chunk</a></span><span class="op">$</span><span class="fu">set</span><span class="op">(</span>echo <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu">here</span><span class="fu">::</span><span class="fu"><a href="https://here.r-lib.org/reference/i_am.html" class="external-link">i_am</a></span><span class="op">(</span><span class="st">"vignettes/simulation-test-models.Rmd"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## here() starts at /home/vp22681/Dropbox/Git/ggoutbreak</span></span></code></pre>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/source.html" class="external-link">source</a></span><span class="op">(</span><span class="fu">here</span><span class="fu">::</span><span class="fu"><a href="https://here.r-lib.org/reference/here.html" class="external-link">here</a></span><span class="op">(</span><span class="st">"vignettes/vignette-utils.R"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ai4ci.github.io/ggoutbreak/">ggoutbreak</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://patchwork.data-imaginist.com" class="external-link">patchwork</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">plot_changes</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">sim</span>, <span class="va">name</span>, <span class="va">max_y</span> <span class="op">=</span> <span class="cn">NA</span>, <span class="va">mapping</span> <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="op">)</span>, <span class="va">case</span><span class="op">=</span><span class="cn">FALSE</span>, <span class="va">fn</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">sim</span>,<span class="st">"fn"</span><span class="op">)</span>, <span class="va">changes</span> <span class="op">=</span> <span class="cn">NULL</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">changes</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">col</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">intersect</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"growth"</span>,<span class="st">"R"</span><span class="op">)</span>,<span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">changes</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">events</span> <span class="op">=</span> <span class="va">changes</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/transmute.html" class="external-link">transmute</a></span><span class="op">(</span></span>
<span>      start <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="fu"><a href="../reference/as.time_period.html">as.time_period</a></span><span class="op">(</span><span class="va">t</span>, unit<span class="op">=</span><span class="va">time_unit</span><span class="op">)</span><span class="op">)</span>,</span>
<span>      end <span class="op">=</span> <span class="cn">NA</span>,</span>
<span>      label <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">col</span>,<span class="st">"=%1.2f"</span><span class="op">)</span>,<span class="op">!</span><span class="op">!</span><span class="fu">rlang</span><span class="fu">::</span><span class="fu"><a href="https://rlang.r-lib.org/reference/sym.html" class="external-link">sym</a></span><span class="op">(</span><span class="va">col</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="kw">else</span></span>
<span>    <span class="va">events</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">sim</span>,<span class="st">"events"</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/force.html" class="external-link">force</a></span><span class="op">(</span><span class="va">fn</span><span class="op">)</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="st">"statistic"</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">sim</span><span class="op">)</span><span class="op">)</span> <span class="va">sim</span> <span class="op">=</span> <span class="va">sim</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">statistic</span> <span class="op">==</span> <span class="st">"infections"</span><span class="op">)</span> </span>
<span>  </span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span>mapping<span class="op">=</span><span class="va">mapping</span><span class="op">)</span><span class="op">+</span></span>
<span>    <span class="op">{</span><span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">events</span><span class="op">)</span><span class="op">)</span> <span class="cn">NULL</span> <span class="kw">else</span> <span class="fu"><a href="../reference/geom_events.html">geom_events</a></span><span class="op">(</span>events<span class="op">=</span><span class="va">events</span><span class="op">)</span><span class="op">}</span><span class="op">+</span></span>
<span>    <span class="op">{</span><span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">fn</span><span class="op">)</span><span class="op">)</span> <span class="cn">NULL</span> <span class="kw">else</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_function.html" class="external-link">geom_function</a></span><span class="op">(</span>fun <span class="op">=</span> <span class="op">~</span> <span class="fu">fn</span><span class="op">(</span>t<span class="op">=</span><span class="fu"><a href="../reference/as.time_period.html">as.time_period</a></span><span class="op">(</span><span class="va">.x</span>, <span class="va">sim</span><span class="op">$</span><span class="va">time</span><span class="op">)</span><span class="op">)</span>, xlim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/range.html" class="external-link">range</a></span><span class="op">(</span><span class="va">sim</span><span class="op">$</span><span class="va">time</span><span class="op">)</span><span class="op">)</span>, n <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">sim</span><span class="op">$</span><span class="va">time</span><span class="op">)</span><span class="op">)</span><span class="op">}</span><span class="op">+</span></span>
<span>    <span class="op">{</span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="st">"rt.weighted"</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">sim</span><span class="op">)</span><span class="op">)</span> <span class="cn">NULL</span> <span class="kw">else</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_step</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">sim</span>, mapping<span class="op">=</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="va">time</span><span class="op">)</span>, y<span class="op">=</span><span class="va">rt.weighted</span><span class="op">)</span><span class="op">)</span><span class="op">}</span><span class="op">+</span></span>
<span>    <span class="op">{</span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="st">"rt.inst"</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">sim</span><span class="op">)</span><span class="op">)</span> <span class="cn">NULL</span> <span class="kw">else</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">sim</span>, mapping<span class="op">=</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="va">time</span><span class="op">)</span>, y<span class="op">=</span><span class="va">rt.inst</span><span class="op">)</span>,size<span class="op">=</span><span class="fl">0.5</span><span class="op">)</span>,</span>
<span>      <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">sim</span>, mapping<span class="op">=</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="va">time</span><span class="op">)</span>, y<span class="op">=</span><span class="va">rt.inst</span><span class="op">)</span>,alpha<span class="op">=</span><span class="fl">0.1</span><span class="op">)</span></span>
<span>    <span class="op">)</span><span class="op">}</span><span class="op">+</span></span>
<span>    <span class="op">{</span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="va">case</span> <span class="op">||</span> <span class="op">!</span><span class="st">"rt.case"</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">sim</span><span class="op">)</span><span class="op">)</span> <span class="cn">NULL</span> <span class="kw">else</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">sim</span>, mapping<span class="op">=</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="va">time</span><span class="op">)</span>, y<span class="op">=</span><span class="va">rt.case</span><span class="op">)</span>, colour<span class="op">=</span><span class="st">"blue"</span>,size<span class="op">=</span><span class="fl">0.5</span><span class="op">)</span>,</span>
<span>      <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">sim</span>, mapping<span class="op">=</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="va">time</span><span class="op">)</span>, y<span class="op">=</span><span class="va">rt.case</span><span class="op">)</span>, colour<span class="op">=</span><span class="st">"blue"</span>,alpha<span class="op">=</span><span class="fl">0.1</span><span class="op">)</span></span>
<span>    <span class="op">)</span><span class="op">}</span><span class="op">+</span></span>
<span>    <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="va">name</span><span class="op">)</span><span class="op">+</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="cn">NULL</span><span class="op">)</span><span class="op">+</span></span>
<span>    <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_cartesian.html" class="external-link">coord_cartesian</a></span><span class="op">(</span>ylim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="cn">NA</span>,<span class="va">max_y</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p><code>ggoutbreak</code> includes a set of simulations that can be
used to generate test data with known parameters. These can be used to
validate the output of model parameter estimates, calculated from
simulated data for which we have gold standard values for those
parameters. Simulations are both at an aggregate level generating count
data, or at an individual level generating line lists.</p>
<p>The parameters implemented so far are as follows:</p>
<ul>
<li>Importation rate</li>
<li>Reproduction number</li>
<li>Growth rate</li>
<li>Infectivity profile (generation time or the time delay of infectee
infection from time of infector infection)</li>
<li>Case ascertainment rate</li>
<li>Probability of symptoms given infection</li>
<li>Time delay of symptom onset from time of infection</li>
<li>Probability of hospital admission given infection</li>
<li>Time delay of hospital admission from time of infection</li>
<li>Probability of death given infection</li>
<li>Time delay of death from time of infection</li>
<li>Probability of testing given infection (or given symptoms)</li>
<li>Time delay of test sampling from time of infection (or
symptoms)</li>
<li>Time delay of test result from time of test sampling</li>
</ul>
<p>Depending on the model some of these may be specified in different
ways. Different delays and rates of observation can be added ad-hoc and
the simulations can be stratified by different classes. In some
simulations this can be propagated using an equivalent to a contact
matrix.</p>
</div>
<div class="section level2">
<h2 id="specifying-time-varying-parameters">Specifying time varying parameters<a class="anchor" aria-label="anchor" href="#specifying-time-varying-parameters"></a>
</h2>
<p>The simulation framework is highly configurable, and a key part of
this is specifying parameters that vary over time, or have some random
or non random day to day variation. Most simulation parameters must be
given as a time varying function, but other parameters are often
available. <code>ggoutbreak</code> includes various ways of generating
these functions, and simulation configuration options that expect a
function are identified by the <code>fn_...</code> prefix, for example
<code>fn_p_symptomatic</code>.</p>
<p>Functions are evaluated in the context of the simulation data frame,
as it is being built. These will always have a time and a count column,
and may have other columns too. The evaluation happens internally but
here we use the <code>.ts_evaluate</code> function to demonstrate the
results.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">demo</span> <span class="op">=</span> <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span></span>
<span>  time <span class="op">=</span> <span class="fl">0</span><span class="op">:</span><span class="fl">9</span>,</span>
<span>  class <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"one"</span>,<span class="st">"two"</span><span class="op">)</span>,<span class="fl">5</span><span class="op">)</span>,</span>
<span>  flag <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="cn">TRUE</span>,<span class="fl">5</span><span class="op">)</span>,<span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="cn">FALSE</span>,<span class="fl">5</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>A static value can be supplied as a purrr style lambda.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/dot-ts_evaluate.html">.ts_evaluate</a></span><span class="op">(</span> <span class="op">~</span> <span class="fl">0.5</span>, <span class="va">demo</span> <span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 0.5</span></span></code></pre>
<p>A time varying function can be supplied as a purrr style lambda where
the first parameter is the <code>time</code> column of the
<code>demo</code> dataframe</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/dot-ts_evaluate.html">.ts_evaluate</a></span><span class="op">(</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">.x</span> <span class="op">&lt;</span> <span class="fl">5</span>, <span class="fl">2</span>, <span class="fl">0.5</span><span class="op">)</span>, <span class="va">demo</span> <span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##  [1] 2.0 2.0 2.0 2.0 2.0 0.5 0.5 0.5 0.5 0.5</span></span></code></pre>
<p>An alternative syntax uses an anonymous function with named
parameters. The time column is always shortened to <code>t</code>. This
format can be used to key off other variables to allow a time varying,
and class specific parameter to be returned</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/dot-ts_evaluate.html">.ts_evaluate</a></span><span class="op">(</span> \<span class="op">(</span><span class="va">t</span>, <span class="va">class</span><span class="op">)</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>  <span class="va">class</span> <span class="op">==</span> <span class="st">"one"</span> <span class="op">~</span> <span class="st">"variant 1 R_t value"</span>,</span>
<span>  <span class="va">class</span> <span class="op">==</span> <span class="st">"two"</span> <span class="op">~</span> <span class="st">"variant 2 R_t value"</span></span>
<span><span class="op">)</span>, <span class="va">demo</span> <span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##  [1] "variant 1 R_t value" "variant 2 R_t value" "variant 1 R_t value"</span></span>
<span><span class="co">##  [4] "variant 2 R_t value" "variant 1 R_t value" "variant 2 R_t value"</span></span>
<span><span class="co">##  [7] "variant 1 R_t value" "variant 2 R_t value" "variant 1 R_t value"</span></span>
<span><span class="co">## [10] "variant 2 R_t value"</span></span></code></pre>
<p>If you don’t know what columns are available providing an empty or
otherwise incorrect function results in the valid parameter names being
displayed in the error message:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/try.html" class="external-link">try</a></span><span class="op">(</span><span class="fu"><a href="../reference/dot-ts_evaluate.html">.ts_evaluate</a></span><span class="op">(</span> \<span class="op">(</span><span class="op">)</span> <span class="op">{</span><span class="op">}</span> , <span class="va">demo</span> <span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Error : Function must define at least one parameter, available values are: t, class, flag</span></span></code></pre>
<div class="section level3">
<h3 id="step-and-linear-functions">Step and linear functions<a class="anchor" aria-label="anchor" href="#step-and-linear-functions"></a>
</h3>
<p>A common need is to set a number of fixed levels, or fixed knots and
have the function interpolate between them. The step function might be
used to parametrise
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>R</mi><mi>t</mi></msub><annotation encoding="application/x-tex">R_t</annotation></semantics></math>
in the event of a lock-down for example.</p>
<p>To make this simple most simulation functions will take a
<code>changes</code> dataframe that defines the time point and the new
value of, either the reproduction number or the growth rate at the time
point. These can be used as parametrisation for the reproduction
number.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">changes</span> <span class="op">=</span> <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span></span>
<span>  t <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">20</span>,<span class="fl">40</span>,<span class="fl">60</span>,<span class="fl">80</span><span class="op">)</span>, </span>
<span>  growth <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.1</span>,<span class="fl">0</span>,<span class="op">-</span><span class="fl">0.1</span>,<span class="fl">0</span>,<span class="fl">0.1</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">fn</span> <span class="op">=</span> <span class="fu"><a href="../reference/cfg_step_fn.html">cfg_step_fn</a></span><span class="op">(</span><span class="va">changes</span><span class="op">)</span></span>
<span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_function.html" class="external-link">geom_function</a></span><span class="op">(</span>fun <span class="op">=</span> <span class="va">fn</span>, xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">100</span><span class="op">)</span><span class="op">)</span><span class="op">+</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"growth rate"</span><span class="op">)</span></span></code></pre></div>
<p><img src="simulation-test-models_files/figure-html/unnamed-chunk-6-1.png" width="700"></p>
<p><code>cfg_linear_fn</code> produces a very similar effect with less
abrupt changes in
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>R</mi><mi>t</mi></msub><annotation encoding="application/x-tex">R_t</annotation></semantics></math>
and changes occurring such that the value at the knot is correct.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">changes</span> <span class="op">=</span> <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span></span>
<span>  t <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">10</span>,<span class="fl">20</span>,<span class="fl">30</span>,<span class="fl">40</span>,<span class="fl">50</span>,<span class="fl">60</span>,<span class="fl">70</span>,<span class="fl">80</span><span class="op">)</span>, </span>
<span>  R <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1.5</span>,<span class="fl">1.75</span>,<span class="fl">1.25</span>,<span class="fl">0.9</span>,<span class="fl">0.7</span>,<span class="fl">0.8</span>,<span class="fl">0.95</span>,<span class="fl">1</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">fn</span> <span class="op">=</span> <span class="fu"><a href="../reference/cfg_linear_fn.html">cfg_linear_fn</a></span><span class="op">(</span><span class="va">changes</span><span class="op">)</span></span>
<span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_function.html" class="external-link">geom_function</a></span><span class="op">(</span>fun <span class="op">=</span> <span class="va">fn</span>, xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">100</span><span class="op">)</span><span class="op">)</span><span class="op">+</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"reproduction number"</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_hline</a></span><span class="op">(</span>yintercept<span class="op">=</span><span class="fl">1</span>,linetype<span class="op">=</span><span class="st">"dashed"</span><span class="op">)</span></span></code></pre></div>
<p><img src="simulation-test-models_files/figure-html/unnamed-chunk-7-1.png" width="700"></p>
</div>
<div class="section level3">
<h3 id="random-functions">Random functions<a class="anchor" aria-label="anchor" href="#random-functions"></a>
</h3>
<p>For some applications (e.g. ascertainment, importation) it might
useful to have a value that includes some random noise, but with the an
expected value of the average. This is easiest with a <code>purrr</code>
style lambda.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># A random normally distributed value with mean 5 and SD 1</span></span>
<span><span class="co"># `.x` here will be interpreted as time as the first parameter, and in this</span></span>
<span><span class="co"># case is only used to size the returned random gaussian.</span></span>
<span><span class="fu"><a href="../reference/dot-ts_evaluate.html">.ts_evaluate</a></span><span class="op">(</span><span class="op">~</span> <span class="fu">stats</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">.x</span>,<span class="fl">5</span>,<span class="fl">1</span><span class="op">)</span>, <span class="va">demo</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##  [1] 3.599956 5.255317 2.562736 4.994429 5.621553 6.148412 3.178182 4.752675</span></span>
<span><span class="co">##  [9] 4.755800 4.717295</span></span></code></pre>
<p>For convenience <code>ggoutbreak</code> includes some RNGs that are
parametrised by mean and a dispersion parameter.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># A random Bernoulli parametrised by probability.</span></span>
<span><span class="fu"><a href="../reference/dot-ts_evaluate.html">.ts_evaluate</a></span><span class="op">(</span><span class="op">~</span> <span class="fu"><a href="../reference/rbern.html">rbern</a></span><span class="op">(</span><span class="va">.x</span>, p <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span>, <span class="va">demo</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##  [1]  TRUE FALSE FALSE  TRUE FALSE FALSE  TRUE FALSE FALSE FALSE</span></span></code></pre>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># A beta distributed quantity parametrised by probability and dispersion (1-high to 0-none)</span></span>
<span><span class="fu"><a href="../reference/dot-ts_evaluate.html">.ts_evaluate</a></span><span class="op">(</span><span class="op">~</span> <span class="fu"><a href="../reference/rbeta2.html">rbeta2</a></span><span class="op">(</span><span class="va">.x</span>, prob <span class="op">=</span> <span class="fl">0.7</span>, kappa <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span>, <span class="va">demo</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##  [1] 0.7506903 0.7129819 0.7013073 0.6861331 0.7230630 0.6881060 0.6908378</span></span>
<span><span class="co">##  [8] 0.7337567 0.7024199 0.7236393</span></span></code></pre>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># A log normal parametrised by mean and SD on the true scale</span></span>
<span><span class="fu"><a href="../reference/dot-ts_evaluate.html">.ts_evaluate</a></span><span class="op">(</span><span class="op">~</span> <span class="fu"><a href="../reference/rlnorm2.html">rlnorm2</a></span><span class="op">(</span><span class="va">.x</span>, mean <span class="op">=</span> <span class="fl">5</span>, sd <span class="op">=</span><span class="fl">1</span><span class="op">)</span>, <span class="va">demo</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##  [1] 4.887440 4.162386 3.633908 5.900688 5.077301 5.145320 6.762271 5.012906</span></span>
<span><span class="co">##  [9] 4.774506 3.358685</span></span></code></pre>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># A gamma parametrised by mean and SD on the true scale</span></span>
<span><span class="fu"><a href="../reference/dot-ts_evaluate.html">.ts_evaluate</a></span><span class="op">(</span><span class="op">~</span> <span class="fu"><a href="../reference/rgamma2.html">rgamma2</a></span><span class="op">(</span><span class="va">.x</span>, mean <span class="op">=</span> <span class="fl">5</span>, sd <span class="op">=</span><span class="fl">1</span><span class="op">)</span>, <span class="va">demo</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##  [1] 4.627468 5.050369 4.614360 4.287724 6.389703 4.144172 8.007341 4.946172</span></span>
<span><span class="co">##  [9] 5.488590 5.017705</span></span></code></pre>
<p>These functions can be combined with other logic to make a time
dependent random number, in this case the first 5 random gammas are
drawn from a distribution with mean 1 and SD 1 and the last 5 from mean
6 and SD 1:</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># A random number from a gamma distribution parametrised by mean and SD on the true scale</span></span>
<span><span class="co"># where the mean is a time varying value. Again here `.x` is the time and it is</span></span>
<span><span class="co"># being used to define the number of returned value sand the mean of these values</span></span>
<span><span class="fu"><a href="../reference/dot-ts_evaluate.html">.ts_evaluate</a></span><span class="op">(</span><span class="op">~</span> <span class="fu"><a href="../reference/rgamma2.html">rgamma2</a></span><span class="op">(</span><span class="va">.x</span>, mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">.x</span> <span class="op">&lt;</span> <span class="fl">5</span>,<span class="fl">1</span>,<span class="fl">6</span><span class="op">)</span>, sd <span class="op">=</span><span class="fl">1</span><span class="op">)</span>, <span class="va">demo</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##  [1] 0.9002344 0.1013501 0.5136526 0.5211211 0.9643644 3.8738828 5.9171433</span></span>
<span><span class="co">##  [8] 6.6902884 6.2615691 6.0851481</span></span></code></pre>
<p>Although time dependence is the most likely scenario, any simulation
component can be used to control gamma and beta distributed quantities.
This allows for configuring variant specific hospitalisation rates, or
delays for example.</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">hospitalisation_prob_fn</span> <span class="op">=</span> <span class="fu"><a href="../reference/cfg_beta_prob_rng.html">cfg_beta_prob_rng</a></span><span class="op">(</span></span>
<span>  probability_fn <span class="op">=</span> \<span class="op">(</span><span class="va">variant</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">variant</span><span class="op">==</span><span class="st">"alpha"</span>, <span class="fl">0.2</span>, <span class="fl">0.02</span><span class="op">)</span>,</span>
<span>  kappa_fn <span class="op">=</span> <span class="op">~</span> <span class="fl">0.1</span></span>
<span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">demo</span> <span class="op">=</span> <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span></span>
<span>  t <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">200</span>,</span>
<span>  variant <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">"wildtype"</span>,<span class="fl">100</span><span class="op">)</span>,<span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">"alpha"</span>, <span class="fl">100</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>  value <span class="op">=</span> <span class="fu"><a href="../reference/dot-ts_evaluate.html">.ts_evaluate</a></span><span class="op">(</span><span class="va">hospitalisation_prob_fn</span>, <span class="va">.</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">demo</span>, <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">variant</span>,y<span class="op">=</span><span class="va">value</span><span class="op">)</span><span class="op">)</span><span class="op">+</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>position <span class="op">=</span> <span class="st">"jitter"</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"probability hospitalisation"</span><span class="op">)</span></span></code></pre></div>
<p><img src="simulation-test-models_files/figure-html/unnamed-chunk-11-1.png" width="700"></p>
</div>
<div class="section level3">
<h3 id="delay-distributions-and-delay-rngs">Delay distributions and delay RNGs<a class="anchor" aria-label="anchor" href="#delay-distributions-and-delay-rngs"></a>
</h3>
<p>A key parameter is the generation interval or infectivity profile
that defines the delay between infection of infector and infectee in a
transmission chain. Other delays such as infection to symptoms, or
infection to admission also need to be parametrised. This is done using
a empirical probability distribution as described in <a href="infectivity-profile-discretisation.html">this vignette</a>
(referred to as ‘IP distributions’). In general IP distributions are
either used for a convolution of summary count data, to simulate the
effect of delay on an aggregate measure, or for random sampling to
generate a delay for each individual in a line list. There are a couple
of ways of constructing these for a simulation:</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">gamma_ip</span> <span class="op">=</span> <span class="fu"><a href="../reference/make_gamma_ip.html">make_gamma_ip</a></span><span class="op">(</span>median_of_mean <span class="op">=</span> <span class="fl">5</span>, median_of_sd <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">emp_ip</span> <span class="op">=</span> <span class="fu"><a href="../reference/make_empirical_ip.html">make_empirical_ip</a></span><span class="op">(</span>omega <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">2</span>,<span class="fl">3</span>,<span class="fl">3</span>,<span class="fl">2</span>,<span class="fl">1</span>,<span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">p1</span><span class="op">=</span><span class="va">gamma_ip</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="../reference/plot_ip.html">plot_ip</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="st">"gamma"</span><span class="op">)</span></span>
<span><span class="va">p2</span><span class="op">=</span><span class="va">emp_ip</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="../reference/plot_ip.html">plot_ip</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="st">"empirical"</span><span class="op">)</span></span>
<span><span class="va">p1</span><span class="op">+</span><span class="va">p2</span><span class="op">+</span><span class="fu">patchwork</span><span class="fu">::</span><span class="fu"><a href="https://patchwork.data-imaginist.com/reference/plot_layout.html" class="external-link">plot_layout</a></span><span class="op">(</span>nrow<span class="op">=</span><span class="fl">1</span><span class="op">)</span><span class="co">#,axes = "collect")</span></span></code></pre></div>
<p><img src="simulation-test-models_files/figure-html/unnamed-chunk-12-1.png" width="700"></p>
<p>The IP distributions are used directly for convolution in aggregate
simulations. For line list simulations we want a random sample to apply
to individuals. For gamma based IP distributions the <code>rgamma</code>
or <code>rgamma2</code> functions could be used directly. For empirical
distributions we can generate random numbers</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">emp_sample_fn</span> <span class="op">=</span> <span class="fu"><a href="../reference/cfg_ip_sampler_rng.html">cfg_ip_sampler_rng</a></span><span class="op">(</span><span class="va">emp_ip</span><span class="op">)</span></span>
<span></span>
<span><span class="va">tmp</span> <span class="op">=</span> <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span></span>
<span>  serial_interval <span class="op">=</span> <span class="fu">emp_sample_fn</span><span class="op">(</span><span class="fl">2000</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">p3</span> <span class="op">=</span> <span class="va">p2</span> <span class="op"><a href="../reference/grapes-above-grapes.html">%above%</a></span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html" class="external-link">geom_histogram</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">tmp</span>,mapping<span class="op">=</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">serial_interval</span>, y<span class="op">=</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes_eval.html" class="external-link">after_stat</a></span><span class="op">(</span><span class="va">density</span><span class="op">)</span><span class="op">)</span>,</span>
<span>      breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0.5</span>,<span class="fl">12</span><span class="op">)</span><span class="op">)</span>,fill<span class="op">=</span><span class="st">"grey80"</span>,colour<span class="op">=</span><span class="st">"grey40"</span><span class="op">)</span></span>
<span><span class="va">p3</span></span></code></pre></div>
<p><img src="simulation-test-models_files/figure-html/unnamed-chunk-13-1.png" width="700"></p>
<p>These IP delay distributions may themselves change over time, or
change as a result of other characteristics of the simulation. This is
difficult to demo outside of the simulation, and we will give some
examples later. In principle though a time varying function for
selecting one of 2 IP delays might look like this:</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># We start by defining a time varying function for the mean of a gamma</span></span>
<span><span class="va">delay_mean_fn</span> <span class="op">=</span> <span class="fu"><a href="../reference/cfg_linear_fn.html">cfg_linear_fn</a></span><span class="op">(</span><span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tribble.html" class="external-link">tribble</a></span><span class="op">(</span></span>
<span>  <span class="op">~</span><span class="va">t</span> , <span class="op">~</span><span class="va">delay</span>,</span>
<span>  <span class="fl">0</span>, <span class="fl">3</span>, <span class="co"># 3 day delays initially,</span></span>
<span>  <span class="fl">4</span>, <span class="fl">3</span>, <span class="co"># Until day 4. Between day 4 and 10 delays improving</span></span>
<span>  <span class="fl">10</span>, <span class="fl">1</span> <span class="co"># by day 10 delays steady at 1 day</span></span>
<span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># We wrap this in a a function to calculate a IP for each time point</span></span>
<span><span class="va">delay_fn</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">t</span><span class="op">)</span> <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span> <span class="fu">delay_mean_fn</span><span class="op">(</span><span class="va">t</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">mean</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="../reference/make_gamma_ip.html">make_gamma_ip</a></span><span class="op">(</span>median_of_mean <span class="op">=</span> <span class="va">mean</span>, median_of_sd <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="va">mean</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Within the simulation this delay function will be evaluated for each day</span></span>
<span><span class="co"># here we do it manually</span></span>
<span></span>
<span><span class="va">times</span> <span class="op">=</span> <span class="fl">0</span><span class="op">:</span><span class="fl">14</span></span>
<span><span class="va">delay_t</span> <span class="op">=</span> <span class="fu">delay_fn</span><span class="op">(</span>t<span class="op">=</span><span class="va">times</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># this is a list of IP distributions.</span></span>
<span><span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span>ip <span class="op">=</span> <span class="va">delay_t</span>, t<span class="op">=</span><span class="va">times</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/unnest.html" class="external-link">unnest</a></span><span class="op">(</span><span class="va">ip</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://pillar.r-lib.org/reference/glimpse.html" class="external-link">glimpse</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html" class="external-link">geom_rect</a></span><span class="op">(</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>xmin<span class="op">=</span><span class="va">t</span>,xmax<span class="op">=</span><span class="va">t</span><span class="op">+</span><span class="fl">1</span>,ymin<span class="op">=</span><span class="va">a0</span>,ymax<span class="op">=</span><span class="va">a1</span>,fill <span class="op">=</span> <span class="va">probability</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"time"</span><span class="op">)</span><span class="op">+</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"delay"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Rows: 158</span></span>
<span><span class="co">## Columns: 6</span></span>
<span><span class="co">## $ tau         <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> 0<span style="color: #949494;">, </span>1<span style="color: #949494;">, </span>2<span style="color: #949494;">, </span>3<span style="color: #949494;">, </span>4<span style="color: #949494;">, </span>5<span style="color: #949494;">, </span>6<span style="color: #949494;">, </span>7<span style="color: #949494;">, </span>8<span style="color: #949494;">, </span>9<span style="color: #949494;">, </span>10<span style="color: #949494;">, </span>11<span style="color: #949494;">, </span>12<span style="color: #949494;">, </span>0<span style="color: #949494;">, </span>1<span style="color: #949494;">, </span>2<span style="color: #949494;">, </span>3<span style="color: #949494;">, </span>4<span style="color: #949494;">, </span>5…</span></span>
<span><span class="co">## $ a0          <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 0.0<span style="color: #949494;">, </span>0.5<span style="color: #949494;">, </span>1.5<span style="color: #949494;">, </span>2.5<span style="color: #949494;">, </span>3.5<span style="color: #949494;">, </span>4.5<span style="color: #949494;">, </span>5.5<span style="color: #949494;">, </span>6.5<span style="color: #949494;">, </span>7.5<span style="color: #949494;">, </span>8.5<span style="color: #949494;">, </span>9.5<span style="color: #949494;">, </span>10.…</span></span>
<span><span class="co">## $ a1          <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 0.5<span style="color: #949494;">, </span>1.5<span style="color: #949494;">, </span>2.5<span style="color: #949494;">, </span>3.5<span style="color: #949494;">, </span>4.5<span style="color: #949494;">, </span>5.5<span style="color: #949494;">, </span>6.5<span style="color: #949494;">, </span>7.5<span style="color: #949494;">, </span>8.5<span style="color: #949494;">, </span>9.5<span style="color: #949494;">, </span>10.5<span style="color: #949494;">, </span>11…</span></span>
<span><span class="co">## $ probability <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 0.0143876780<span style="color: #949494;">, </span>0.1767654915<span style="color: #949494;">, </span>0.2650337147<span style="color: #949494;">, </span>0.2229659170<span style="color: #949494;">, </span>0.…</span></span>
<span><span class="co">## $ boot        <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> 1<span style="color: #949494;">, </span>1<span style="color: #949494;">, </span>1<span style="color: #949494;">, </span>1<span style="color: #949494;">, </span>1<span style="color: #949494;">, </span>1<span style="color: #949494;">, </span>1<span style="color: #949494;">, </span>1<span style="color: #949494;">, </span>1<span style="color: #949494;">, </span>1<span style="color: #949494;">, </span>1<span style="color: #949494;">, </span>1<span style="color: #949494;">, </span>1<span style="color: #949494;">, </span>1<span style="color: #949494;">, </span>1<span style="color: #949494;">, </span>1<span style="color: #949494;">, </span>1<span style="color: #949494;">, </span>1<span style="color: #949494;">, </span>1<span style="color: #949494;">, </span>1…</span></span>
<span><span class="co">## $ t           <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> 0<span style="color: #949494;">, </span>0<span style="color: #949494;">, </span>0<span style="color: #949494;">, </span>0<span style="color: #949494;">, </span>0<span style="color: #949494;">, </span>0<span style="color: #949494;">, </span>0<span style="color: #949494;">, </span>0<span style="color: #949494;">, </span>0<span style="color: #949494;">, </span>0<span style="color: #949494;">, </span>0<span style="color: #949494;">, </span>0<span style="color: #949494;">, </span>0<span style="color: #949494;">, </span>1<span style="color: #949494;">, </span>1<span style="color: #949494;">, </span>1<span style="color: #949494;">, </span>1<span style="color: #949494;">, </span>1<span style="color: #949494;">, </span>1<span style="color: #949494;">, </span>1…</span></span></code></pre>
<p><img src="simulation-test-models_files/figure-html/unnamed-chunk-14-1.png" width="700"></p>
<p>For time varying delays in individual based models things are a
little simpler. We create RNG that has a mean for every individual in
the simulation.</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">delay_mean_fn</span> <span class="op">=</span> <span class="fu"><a href="../reference/cfg_linear_fn.html">cfg_linear_fn</a></span><span class="op">(</span><span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tribble.html" class="external-link">tribble</a></span><span class="op">(</span></span>
<span>  <span class="op">~</span><span class="va">t</span> , <span class="op">~</span><span class="va">delay</span>,</span>
<span>  <span class="fl">0</span>, <span class="fl">3</span>, <span class="co"># 3 day delays initially,</span></span>
<span>  <span class="fl">4</span>, <span class="fl">3</span>, <span class="co"># Until day 4. Between day 4 and 10 delays improving</span></span>
<span>  <span class="fl">10</span>, <span class="fl">1</span> <span class="co"># by day 10 delays steady at 1 day</span></span>
<span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">delay_rng</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">t</span><span class="op">)</span> <span class="op">{</span> <span class="fu"><a href="../reference/rgamma2.html">rgamma2</a></span><span class="op">(</span><span class="va">t</span>, <span class="fu">delay_mean_fn</span><span class="op">(</span><span class="va">t</span><span class="op">)</span><span class="op">)</span> <span class="op">}</span></span>
<span></span>
<span><span class="va">times</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span><span class="op">:</span><span class="fl">14</span>,<span class="fl">1000</span><span class="op">)</span></span>
<span><span class="va">delay</span> <span class="op">=</span> <span class="fu">delay_rng</span><span class="op">(</span>t<span class="op">=</span><span class="va">times</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span>delay <span class="op">=</span> <span class="va">delay</span>, t<span class="op">=</span><span class="va">times</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_boxplot.html" class="external-link">geom_boxplot</a></span><span class="op">(</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">t</span><span class="op">)</span>,y<span class="op">=</span><span class="va">delay</span><span class="op">)</span>,outliers <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"time"</span><span class="op">)</span><span class="op">+</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"delay"</span><span class="op">)</span></span></code></pre></div>
<p><img src="simulation-test-models_files/figure-html/unnamed-chunk-15-1.png" width="700"></p>
<p>These approaches can be applied to any delay distribution, other than
time to infection such as time to hospitalisation, and so these can be
made to vary on other variables in the simulation such as variant class
or potentially patient age.</p>
</div>
<div class="section level3">
<h3 id="periodic-functions">Periodic functions<a class="anchor" aria-label="anchor" href="#periodic-functions"></a>
</h3>
<p>A periodic function is most obviously useful to generate seasonal
forcing:</p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># A simple to interpret and easy to make integrate to 0, so that growth remains</span></span>
<span><span class="co"># bounded. </span></span>
<span><span class="va">growth_rate_fn</span> <span class="op">=</span> \<span class="op">(</span><span class="va">t</span><span class="op">)</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>  <span class="va">t</span> <span class="op"><a href="https://rdrr.io/r/base/Arithmetic.html" class="external-link">%%</a></span> <span class="fl">365</span> <span class="op">&lt;</span> <span class="fl">40</span> <span class="op">~</span> <span class="fl">0.1</span>,</span>
<span>  <span class="va">t</span> <span class="op"><a href="https://rdrr.io/r/base/Arithmetic.html" class="external-link">%%</a></span> <span class="fl">365</span> <span class="op">&lt;</span> <span class="fl">80</span> <span class="op">~</span> <span class="op">-</span><span class="fl">0.1</span>,</span>
<span>  <span class="cn">TRUE</span> <span class="op">~</span> <span class="fl">0</span><span class="op">)</span></span>
<span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_function.html" class="external-link">geom_function</a></span><span class="op">(</span>fun <span class="op">=</span> <span class="va">growth_rate_fn</span>, xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">365</span><span class="op">*</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span><span class="op">+</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"growth rate"</span><span class="op">)</span></span></code></pre></div>
<p><img src="simulation-test-models_files/figure-html/unnamed-chunk-16-1.png" width="700"></p>
<p>Other important uses for periodic functions is to simulate the
patterns of within week variation. This is often seen in testing data as
a result of delays to being tested, or to test processing over the
weekend. To model this we have two variants of weekly periodicity that
use a gamma distribution for the delay. One can be used represent the
delay distribution for convolution in count based simulations and
another for random sampling in individual based simulations.</p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">gamma_means</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">4</span>,<span class="fl">3</span>,<span class="fl">2</span><span class="op">)</span></span>
<span><span class="va">delay_fn</span> <span class="op">=</span> <span class="fu"><a href="../reference/cfg_weekly_ip_fn.html">cfg_weekly_ip_fn</a></span><span class="op">(</span>mean<span class="op">=</span><span class="va">gamma_means</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># delay_fn can be used as the parameter for a delay distribution convolution </span></span>
<span><span class="co"># format_ip takes a probability based delay distribution and gives us a summary</span></span>
<span><span class="co"># the mean, sd, etc.</span></span>
<span><span class="fu"><a href="../reference/dot-ts_evaluate.html">.ts_evaluate</a></span><span class="op">(</span><span class="va">delay_fn</span>, <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span>t<span class="op">=</span><span class="fl">1</span><span class="op">:</span><span class="fl">7</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map_chr</a></span><span class="op">(</span><span class="va">format_ip</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "mean: 1.06; sd: 1.01" "mean: 1.06; sd: 1.01" "mean: 1.06; sd: 1.01"</span></span>
<span><span class="co">## [4] "mean: 1.06; sd: 1.01" "mean: 4; sd: 2.04"    "mean: 3; sd: 1.77"   </span></span>
<span><span class="co">## [7] "mean: 2.02; sd: 1.44"</span></span></code></pre>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># for line list functions a RNG with weekly periodicity generates samples </span></span>
<span><span class="co"># of the interval that is consistent with the parameters passed to </span></span>
<span><span class="co"># `cfg_weekly_gamma_rng`</span></span>
<span><span class="va">delay_rng</span> <span class="op">=</span> <span class="fu"><a href="../reference/cfg_weekly_gamma_rng.html">cfg_weekly_gamma_rng</a></span><span class="op">(</span>mean<span class="op">=</span><span class="va">gamma_means</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span>t<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">7</span>,<span class="fl">100</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>sample <span class="op">=</span> <span class="fu"><a href="../reference/dot-ts_evaluate.html">.ts_evaluate</a></span><span class="op">(</span><span class="va">delay_rng</span>, <span class="va">.</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">t</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span></span>
<span>    mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">sample</span><span class="op">)</span>,</span>
<span>    sd <span class="op">=</span> <span class="fu">stats</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/stats/sd.html" class="external-link">sd</a></span><span class="op">(</span><span class="va">sample</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    expected_mean <span class="op">=</span> <span class="va">gamma_means</span>,</span>
<span>    expected_sd <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="va">gamma_means</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #949494;"># A tibble: 7 × 5</span></span></span>
<span><span class="co">##       t  mean    sd expected_mean expected_sd</span></span>
<span><span class="co">##   <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>         <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>       <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;">1</span>     1 1.07  1.01              1        1   </span></span>
<span><span class="co">## <span style="color: #BCBCBC;">2</span>     2 0.973 0.926             1        1   </span></span>
<span><span class="co">## <span style="color: #BCBCBC;">3</span>     3 0.845 0.767             1        1   </span></span>
<span><span class="co">## <span style="color: #BCBCBC;">4</span>     4 0.842 0.823             1        1   </span></span>
<span><span class="co">## <span style="color: #BCBCBC;">5</span>     5 4.02  1.81              4        2   </span></span>
<span><span class="co">## <span style="color: #BCBCBC;">6</span>     6 3.13  1.87              3        1.73</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">7</span>     7 2.07  1.43              2        1.41</span></span></code></pre>
<p>We will demonstrate this in a simulation later.</p>
</div>
</div>
<div class="section level2">
<h2 id="simulation-cookbook">Simulation cookbook<a class="anchor" aria-label="anchor" href="#simulation-cookbook"></a>
</h2>
<div class="section level3">
<h3 id="count-based-simulations">Count based simulations<a class="anchor" aria-label="anchor" href="#count-based-simulations"></a>
</h3>
<p>Count based models are typically based around a poisson process where
the expected number of cases per day is expressed as a function of
imports and growth, either in terms of the exponential growth rate, or a
combination of the reproduction number and infectivity profile
(generation time).</p>
<div class="section level4">
<h4 id="basic-growth-rate-possion-model-with-ascertainment-noise-">Basic growth rate possion model with ascertainment noise.<a class="anchor" aria-label="anchor" href="#basic-growth-rate-possion-model-with-ascertainment-noise-"></a>
</h4>
<p>Daily count simulations are based around defined incidence rates,
which can be expressed in terms of a time dependent growth rate and an
time dependent importation rate. From this a incidence time series can
be generated using a poisson or negative binomial distribution. We can
also define a simulation in terms of time dependent reproduction number,
time dependent infectivity profile, and a time dependent importation
rate.</p>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">withr</span><span class="fu">::</span><span class="fu"><a href="https://withr.r-lib.org/reference/with_options.html" class="external-link">with_options</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">'day_zero'</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.Date</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>,<span class="op">{</span></span>
<span></span>
<span>  <span class="co"># define a growth rate time series</span></span>
<span>  <span class="va">changes</span> <span class="op">=</span> <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span></span>
<span>    t <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">15</span>,<span class="fl">40</span>,<span class="fl">60</span>,<span class="fl">80</span><span class="op">)</span>, </span>
<span>    growth <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.1</span>,<span class="fl">0.01</span>,<span class="op">-</span><span class="fl">0.075</span>,<span class="fl">0</span>,<span class="fl">0.05</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">sim</span> <span class="op">=</span> <span class="fu"><a href="../reference/sim_poisson_model.html">sim_poisson_model</a></span><span class="op">(</span></span>
<span>    changes <span class="op">=</span> <span class="va">changes</span>,</span>
<span>    max_time <span class="op">=</span> <span class="fl">120</span>,</span>
<span>    time_unit <span class="op">=</span> <span class="st">"1 day"</span></span>
<span>  <span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">p1</span> <span class="op">=</span> <span class="fu">plot_changes</span><span class="op">(</span><span class="va">sim</span>, <span class="st">"parametrised growth rate"</span>, date_breaks <span class="op">=</span> <span class="st">"2 weeks"</span><span class="op">)</span> </span>
<span>  <span class="va">p2</span> <span class="op">=</span> <span class="fu">ggoutbreak</span><span class="fu">::</span><span class="fu"><a href="../reference/plot_counts.html">plot_counts</a></span><span class="op">(</span><span class="va">sim</span>, events <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">sim</span>,<span class="st">"events"</span><span class="op">)</span>, date_breaks <span class="op">=</span> <span class="st">"2 weeks"</span><span class="op">)</span></span>
<span>  <span class="va">p1</span><span class="op">+</span><span class="va">p2</span><span class="op">+</span><span class="fu">patchwork</span><span class="fu">::</span><span class="fu"><a href="https://patchwork.data-imaginist.com/reference/plot_annotation.html" class="external-link">plot_annotation</a></span><span class="op">(</span>tag_levels <span class="op">=</span> <span class="st">"A"</span><span class="op">)</span><span class="op">+</span><span class="fu"><a href="https://patchwork.data-imaginist.com/reference/plot_layout.html" class="external-link">plot_layout</a></span><span class="op">(</span>ncol<span class="op">=</span><span class="fl">1</span>,axes <span class="op">=</span> <span class="st">"collect"</span><span class="op">)</span></span>
<span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## interfacer: development mode active (local function).</span></span>
<span><span class="co">## No `start_date` (or `anchor`) specified. Using default (N.b. set `options('day_zero'=XXX)` to change): 2019-12-29</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## <span style="color: #555555;">This message is displayed once every 8 hours.</span></span></span></code></pre>
<p><img src="simulation-test-models_files/figure-html/unnamed-chunk-19-1.png" width="700"></p>
<p>This produces summary statistics only. With the growth rate and an
infectivity profile, we can use the methods of Wallinga and Lipsitch to
infer a theoretical value of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>R</mi><mi>t</mi></msub><annotation encoding="application/x-tex">R_t</annotation></semantics></math>,
giving us a ground truth to validate
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>R</mi><mi>t</mi></msub><annotation encoding="application/x-tex">R_t</annotation></semantics></math>
estimates.</p>
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># COVID-19 generation time estimates from Ganyani et al 2020.</span></span>
<span><span class="va">ip</span> <span class="op">=</span> <span class="fu"><a href="../reference/make_gamma_ip.html">make_gamma_ip</a></span><span class="op">(</span><span class="fl">5.2</span>, <span class="fl">3.78</span>, <span class="fl">6.78</span>, <span class="fl">1.72</span>, <span class="fl">0.91</span>, <span class="fl">3.93</span>, epiestim_sampler<span class="op">=</span><span class="cn">FALSE</span>, epiestim_compat<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">fn_Rt</span> <span class="op">=</span> <span class="va">changes</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/transmute.html" class="external-link">transmute</a></span><span class="op">(</span></span>
<span>    <span class="va">t</span>,</span>
<span>    R_t <span class="op">=</span> <span class="fu"><a href="../reference/wallinga_lipsitch.html">wallinga_lipsitch</a></span><span class="op">(</span><span class="va">growth</span>, y <span class="op">=</span> <span class="va">ip</span><span class="op">$</span><span class="va">probability</span>, a0 <span class="op">=</span> <span class="va">ip</span><span class="op">$</span><span class="va">a0</span>, a1 <span class="op">=</span> <span class="va">ip</span><span class="op">$</span><span class="va">a1</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/cfg_step_fn.html">cfg_step_fn</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">plot_changes</span><span class="op">(</span><span class="va">sim</span>, <span class="st">"parametrised reproduction number"</span>, fn<span class="op">=</span><span class="va">fn_Rt</span>, date_breaks <span class="op">=</span> <span class="st">"2 weeks"</span><span class="op">)</span> </span></code></pre></div>
<p><img src="simulation-test-models_files/figure-html/unnamed-chunk-20-1.png" width="700"></p>
<p>Simulated noise can be introduced by scaling the incidence rate by a
random ascertainment rate, which can vary over time. The randomness
factor (<code>kappa</code> - a measure of dispersion) is calibrated to
range from 0 (none) to 1 (maximum).</p>
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sim2</span> <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0.25</span>,<span class="fl">0.5</span>,<span class="fl">1</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">k</span><span class="op">)</span> </span>
<span>    <span class="va">sim</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="../reference/sim_apply_ascertainment.html">sim_apply_ascertainment</a></span><span class="op">(</span></span>
<span>      fn_asc <span class="op">=</span> <span class="op">~</span> <span class="fu"><a href="../reference/rbeta2.html">rbeta2</a></span><span class="op">(</span><span class="va">.x</span>, prob <span class="op">=</span> <span class="fl">0.7</span>, kappa <span class="op">=</span> <span class="va">k</span><span class="op">)</span></span>
<span>    <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>ascertainment_noise <span class="op">=</span> <span class="va">k</span><span class="op">)</span> </span>
<span>  <span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">ascertainment_noise</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">ggoutbreak</span><span class="fu">::</span><span class="fu"><a href="../reference/plot_counts.html">plot_counts</a></span><span class="op">(</span><span class="va">sim2</span>, events <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">sim</span>,<span class="st">"events"</span><span class="op">)</span>, date_breaks <span class="op">=</span> <span class="st">"2 weeks"</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"randomness: %1.2f"</span>,<span class="va">ascertainment_noise</span><span class="op">)</span>,ncol<span class="op">=</span><span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<p><img src="simulation-test-models_files/figure-html/unnamed-chunk-21-1.png" width="700"></p>
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Noise introduced by random day to day ascertainment variation:</span></span></code></pre></div>
<p>In this example we select a time varying delay distribution,
reflecting test processing delays, due to setting up testing and then a
public holiday. These can be applied as a time-varying convolution
filter on summary case count simulations to simulate the effect that
changing delay distributions has on aggregate case counts. For example
dynamic delays in test processing can result in slow down and catch up
anomalies.</p>
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ip_mean_fn</span> <span class="op">=</span> <span class="fu"><a href="../reference/cfg_linear_fn.html">cfg_linear_fn</a></span><span class="op">(</span><span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tribble.html" class="external-link">tribble</a></span><span class="op">(</span></span>
<span>  <span class="op">~</span><span class="va">t</span> , <span class="op">~</span><span class="va">delay</span>,</span>
<span>  <span class="fl">0</span>, <span class="fl">3</span>, <span class="co"># 3 day avg delays initially</span></span>
<span>  <span class="fl">10</span>, <span class="fl">1</span>, <span class="co"># by day 10 delays decreased to 1</span></span>
<span>  <span class="fl">25</span>, <span class="fl">1</span>, <span class="co"># remain steady until day 25</span></span>
<span>  <span class="fl">26</span>, <span class="fl">3</span>, <span class="co"># public holiday on day 26 </span></span>
<span>  <span class="fl">27</span>, <span class="fl">3</span>, <span class="co"># and day 27</span></span>
<span>  <span class="fl">28</span>, <span class="fl">1</span> <span class="co"># returning to normal on day 28</span></span>
<span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">p_detection_fn</span> <span class="op">=</span> <span class="fu"><a href="../reference/cfg_linear_fn.html">cfg_linear_fn</a></span><span class="op">(</span><span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tribble.html" class="external-link">tribble</a></span><span class="op">(</span></span>
<span>  <span class="op">~</span><span class="va">t</span> , <span class="op">~</span><span class="va">p</span>,</span>
<span>  <span class="fl">0</span>, <span class="fl">0.1</span>, <span class="co"># initial low probability of detection</span></span>
<span>  <span class="fl">10</span>, <span class="fl">0.7</span>,</span>
<span>  <span class="fl">90</span>, <span class="fl">0.7</span>,</span>
<span>  <span class="fl">120</span>,<span class="fl">0.3</span></span>
<span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">delay_detection_fn</span> <span class="op">=</span> <span class="op">~</span> <span class="fu"><a href="../reference/make_gamma_ip.html">make_gamma_ip</a></span><span class="op">(</span>median_of_mean <span class="op">=</span> <span class="fu">ip_mean_fn</span><span class="op">(</span><span class="va">.x</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">sim3</span> <span class="op">=</span> <span class="va">sim</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="../reference/sim_convolution.html">sim_convolution</a></span><span class="op">(</span></span>
<span>  p_fn <span class="op">=</span> <span class="va">p_detection_fn</span>,</span>
<span>  delay_fn <span class="op">=</span> <span class="va">delay_detection_fn</span>,</span>
<span>  output <span class="op">=</span> <span class="st">"detected"</span></span>
<span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="../reference/sim_delayed_observation.html">sim_delayed_observation</a></span><span class="op">(</span></span>
<span>  input <span class="op">=</span> <span class="st">"detected"</span>,</span>
<span>  delay_fn <span class="op">=</span> <span class="op">~</span> <span class="fu"><a href="../reference/make_gamma_ip.html">make_gamma_ip</a></span><span class="op">(</span><span class="fl">7</span>,median_of_sd <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">p1</span><span class="op">=</span><span class="fu">plot_changes</span><span class="op">(</span><span class="va">sim3</span>,name <span class="op">=</span> <span class="st">"delays (days)"</span>, fn <span class="op">=</span> <span class="va">ip_mean_fn</span><span class="op">)</span><span class="op">+</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html" class="external-link">ylim</a></span><span class="op">(</span><span class="fl">0</span>,<span class="cn">NA</span><span class="op">)</span></span>
<span><span class="va">p2</span><span class="op">=</span><span class="fu">plot_changes</span><span class="op">(</span><span class="va">sim3</span>,name <span class="op">=</span> <span class="st">"detection"</span>, fn <span class="op">=</span> <span class="va">p_detection_fn</span><span class="op">)</span><span class="op">+</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html" class="external-link">ylim</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">p3</span><span class="op">=</span><span class="fu"><a href="../reference/plot_counts.html">plot_counts</a></span><span class="op">(</span><span class="va">sim3</span>,events <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">sim3</span>,<span class="st">"events"</span><span class="op">)</span>,mapping<span class="op">=</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>colour<span class="op">=</span><span class="va">statistic</span><span class="op">)</span><span class="op">)</span><span class="op">+</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">p1</span><span class="op">+</span><span class="va">p2</span><span class="op">+</span><span class="va">p3</span><span class="op">+</span><span class="fu">patchwork</span><span class="fu">::</span><span class="fu"><a href="https://patchwork.data-imaginist.com/reference/plot_layout.html" class="external-link">plot_layout</a></span><span class="op">(</span>ncol<span class="op">=</span><span class="fl">1</span>,heights<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">2</span><span class="op">)</span>,axes <span class="op">=</span> <span class="st">"collect"</span><span class="op">)</span></span></code></pre></div>
<p><img src="simulation-test-models_files/figure-html/unnamed-chunk-22-1.png" width="700"></p>
</div>
<div class="section level4">
<h4 id="seasonal-outbreak-using-a-reproduction-number">Seasonal outbreak using a reproduction number<a class="anchor" aria-label="anchor" href="#seasonal-outbreak-using-a-reproduction-number"></a>
</h4>
<p>We can simulate a seasonal outbreak by providing a periodic growth
rate or
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>R</mi><mi>t</mi></msub><annotation encoding="application/x-tex">R_t</annotation></semantics></math>
as a parameter to a simple poisson model. In this example we also
simulated a default set of delays which keying off an infection event,
generate a delayed set of symptom observations, test samples, results,
hospitalisations and death time series.</p>
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">seasonal_rt_fn</span> <span class="op">=</span> \<span class="op">(</span><span class="va">t</span><span class="op">)</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>  <span class="va">t</span> <span class="op"><a href="https://rdrr.io/r/base/Arithmetic.html" class="external-link">%%</a></span> <span class="fl">365</span> <span class="op">&lt;</span> <span class="fl">20</span> <span class="op">~</span> <span class="fl">2.5</span>,</span>
<span>  <span class="va">t</span> <span class="op"><a href="https://rdrr.io/r/base/Arithmetic.html" class="external-link">%%</a></span> <span class="fl">365</span> <span class="op">&lt;</span> <span class="fl">60</span> <span class="op">~</span> <span class="fl">0.6</span>,</span>
<span>  <span class="cn">TRUE</span> <span class="op">~</span> <span class="fl">1</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">seasonal_imports</span> <span class="op">=</span> \<span class="op">(</span><span class="va">t</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span></span>
<span>  <span class="va">t</span> <span class="op"><a href="https://rdrr.io/r/base/Arithmetic.html" class="external-link">%%</a></span> <span class="fl">365</span> <span class="op">&lt;</span> <span class="fl">5</span>, <span class="fl">5</span>, <span class="fl">0</span> </span>
<span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">seasonal_sim</span> <span class="op">=</span> <span class="fu"><a href="../reference/sim_poisson_Rt_model.html">sim_poisson_Rt_model</a></span><span class="op">(</span></span>
<span>    max_time <span class="op">=</span> <span class="fl">365</span><span class="op">*</span><span class="fl">3</span>,</span>
<span>    fn_Rt <span class="op">=</span> <span class="va">seasonal_rt_fn</span>,</span>
<span>    fn_imports <span class="op">=</span> <span class="va">seasonal_imports</span>,</span>
<span>    fn_ip <span class="op">=</span> <span class="op">~</span> <span class="fu"><a href="../reference/make_gamma_ip.html">make_gamma_ip</a></span><span class="op">(</span><span class="fl">6</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co">#profvis::profvis(</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/system.time.html" class="external-link">system.time</a></span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="va">seasonal_sim</span> <span class="op">=</span> <span class="va">seasonal_sim</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="../reference/sim_apply_delay.html">sim_apply_delay</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##    user  system elapsed </span></span>
<span><span class="co">##  13.801   0.005  13.813</span></span></code></pre>
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#)</span></span>
<span></span>
<span><span class="va">p1</span><span class="op">=</span><span class="fu">plot_changes</span><span class="op">(</span></span>
<span>        <span class="va">seasonal_sim</span>, </span>
<span>        name <span class="op">=</span> <span class="st">"Rt"</span>, </span>
<span>        fn <span class="op">=</span> <span class="va">seasonal_rt_fn</span>, </span>
<span>        max_y <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span></span>
<span><span class="va">p2</span><span class="op">=</span><span class="fu"><a href="../reference/plot_counts.html">plot_counts</a></span><span class="op">(</span></span>
<span>        <span class="va">seasonal_sim</span>, </span>
<span>        events <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">seasonal_sim</span>,<span class="st">"events"</span><span class="op">)</span>,</span>
<span>        mapping<span class="op">=</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>colour<span class="op">=</span><span class="va">statistic</span><span class="op">)</span>,size<span class="op">=</span><span class="fl">0.25</span><span class="op">)</span><span class="op">+</span></span>
<span>      <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>      <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span> <span class="va">statistic</span>,ncol<span class="op">=</span><span class="fl">1</span>,scales <span class="op">=</span> <span class="st">"free_y"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">p1</span><span class="op">+</span><span class="va">p2</span><span class="op">+</span><span class="fu">patchwork</span><span class="fu">::</span><span class="fu"><a href="https://patchwork.data-imaginist.com/reference/plot_layout.html" class="external-link">plot_layout</a></span><span class="op">(</span>ncol<span class="op">=</span><span class="fl">1</span>,axes <span class="op">=</span> <span class="st">"collect"</span>,heights<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">10</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="simulation-test-models_files/figure-html/unnamed-chunk-23-1.png" width="700"></p>
</div>
</div>
</div>
<div class="section level2">
<h2 id="line-list-simulations">Line list simulations<a class="anchor" aria-label="anchor" href="#line-list-simulations"></a>
</h2>
<p>When we want to investigate estimates of delays such as the serial
interval, or rates such as the case fatality rate, it is necessary to
simulate individuals and their interaction. To do this we use a
branching process model parametrised directly with
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>R</mi><mi>t</mi></msub><annotation encoding="application/x-tex">R_t</annotation></semantics></math>.
The time varying
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>R</mi><mi>t</mi></msub><annotation encoding="application/x-tex">R_t</annotation></semantics></math>
defines the expected number of onward infections for each individual
which is sampled using a poisson or negative binomial distribution. Each
infectee is then given a time of infection depending on a specified
infectivity profile, and the times of further events such as symptom
onset, hospitalisation, death, test sampling, and test results can be
assigned, following known event probabilities and delay distributions.
Summary counts of all these events indexed on the time of event,
demonstrate well known biases, such as right truncation. This simulation
is directly parametrised with a theoretical
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>R</mi><mi>t</mi></msub><annotation encoding="application/x-tex">R_t</annotation></semantics></math>
value; summary of the network edges gives us a realised case
reproduction number which is specific for an individual simulation, and
the force of infection gives us a instantaneous reproduction number
estimate for the individual simulation. From the parametrised
infectivity profile we can again use the methods of Wallinga and
Lipsitch to solve for a theoretical growth rate.</p>
<div class="section level3">
<h3 id="basic-outbreak-with-delays-and-censoring">Basic outbreak with delays and censoring<a class="anchor" aria-label="anchor" href="#basic-outbreak-with-delays-and-censoring"></a>
</h3>
<p>A minimal outbreak simulation using a branching process model takes a
time varying function for the reproduction number and a time varying
function for the number of imported cases. This generates a set of
infection events for the specified time period (staring at day 0).</p>
<div class="sourceCode" id="cb47"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># A simple outbreak</span></span>
<span><span class="va">linelist</span> <span class="op">=</span> <span class="fu"><a href="../reference/sim_branching_process.html">sim_branching_process</a></span><span class="op">(</span></span>
<span>   fn_Rt <span class="op">=</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">.x</span> <span class="op">&lt;</span> <span class="fl">40</span>, <span class="fl">1.5</span>, <span class="fl">0.95</span><span class="op">)</span>,</span>
<span>   max_time <span class="op">=</span> <span class="fl">120</span>,</span>
<span>   seed <span class="op">=</span> <span class="fl">100</span>,</span>
<span>   fn_imports <span class="op">=</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">.x</span><span class="op">&lt;</span><span class="fl">10</span>,<span class="fl">8</span>,<span class="fl">0</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## ................................complete</span></span></code></pre>
<div class="sourceCode" id="cb49"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot_cases.html">plot_cases</a></span><span class="op">(</span><span class="va">linelist</span>, events <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">linelist</span>,<span class="st">"events"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_cartesian.html" class="external-link">coord_cartesian</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="simulation-test-models_files/figure-html/unnamed-chunk-24-1.png" width="700"></p>
<p>From this set of infections we can add in a observations, based on
the probability of observation and the delay of observation. Both of
these are time varying functions, which can for example vary as a result
of the day of the week. In this example we add a “sequencing” column set
that describes when a sample was taken for genomic sequencing. This
sampling is delayed slightly more on infections arising at the
weekend.</p>
<div class="sourceCode" id="cb50"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">linelist2</span> <span class="op">=</span> <span class="va">linelist</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="../reference/sim_delay.html">sim_delay</a></span><span class="op">(</span></span>
<span>  p_fn <span class="op">=</span> <span class="op">~</span> <span class="fl">0.6</span>, </span>
<span>  delay_fn <span class="op">=</span> <span class="fu"><a href="../reference/cfg_weekly_gamma_rng.html">cfg_weekly_gamma_rng</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">3</span>,<span class="fl">3</span>,<span class="fl">3</span>,<span class="fl">3</span>,<span class="fl">3</span>,<span class="fl">3.5</span>,<span class="fl">3.5</span><span class="op">)</span>, sd<span class="op">=</span><span class="fl">1</span><span class="op">)</span>,</span>
<span>  output <span class="op">=</span> <span class="st">"sequencing"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># The delay function results in additional columns prefixed by "sequencing"</span></span>
<span><span class="co"># of reach individual.</span></span>
<span><span class="va">linelist2</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://pillar.r-lib.org/reference/glimpse.html" class="external-link">glimpse</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Rows: 18,450</span></span>
<span><span class="co">## Columns: 8</span></span>
<span><span class="co">## $ time                <span style="color: #949494; font-style: italic;">&lt;time_prd&gt;</span> 0<span style="color: #949494;">, </span>0<span style="color: #949494;">, </span>0<span style="color: #949494;">, </span>0<span style="color: #949494;">, </span>0<span style="color: #949494;">, </span>0<span style="color: #949494;">, </span>0<span style="color: #949494;">, </span>0<span style="color: #949494;">, </span>1<span style="color: #949494;">, </span>1<span style="color: #949494;">, </span>1<span style="color: #949494;">, </span>1<span style="color: #949494;">, </span>1<span style="color: #949494;">, </span>1<span style="color: #949494;">, </span>1<span style="color: #949494;">, </span>…</span></span>
<span><span class="co">## $ id                  <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> 1<span style="color: #949494;">, </span>2<span style="color: #949494;">, </span>3<span style="color: #949494;">, </span>4<span style="color: #949494;">, </span>5<span style="color: #949494;">, </span>6<span style="color: #949494;">, </span>7<span style="color: #949494;">, </span>8<span style="color: #949494;">, </span>9<span style="color: #949494;">, </span>10<span style="color: #949494;">, </span>11<span style="color: #949494;">, </span>12<span style="color: #949494;">, </span>13<span style="color: #949494;">, </span>14<span style="color: #949494;">, </span>15<span style="color: #949494;">,</span>…</span></span>
<span><span class="co">## $ generation_interval <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #BB0000;">NA</span><span style="color: #949494;">, </span><span style="color: #BB0000;">NA</span><span style="color: #949494;">, </span><span style="color: #BB0000;">NA</span><span style="color: #949494;">, </span><span style="color: #BB0000;">NA</span><span style="color: #949494;">, </span><span style="color: #BB0000;">NA</span><span style="color: #949494;">, </span><span style="color: #BB0000;">NA</span><span style="color: #949494;">, </span><span style="color: #BB0000;">NA</span><span style="color: #949494;">, </span><span style="color: #BB0000;">NA</span><span style="color: #949494;">, </span><span style="color: #BB0000;">NA</span><span style="color: #949494;">, </span><span style="color: #BB0000;">NA</span><span style="color: #949494;">, </span><span style="color: #BB0000;">NA</span><span style="color: #949494;">, </span><span style="color: #BB0000;">NA</span><span style="color: #949494;">, </span><span style="color: #BB0000;">NA</span>…</span></span>
<span><span class="co">## $ infector            <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #BB0000;">NA</span><span style="color: #949494;">, </span><span style="color: #BB0000;">NA</span><span style="color: #949494;">, </span><span style="color: #BB0000;">NA</span><span style="color: #949494;">, </span><span style="color: #BB0000;">NA</span><span style="color: #949494;">, </span><span style="color: #BB0000;">NA</span><span style="color: #949494;">, </span><span style="color: #BB0000;">NA</span><span style="color: #949494;">, </span><span style="color: #BB0000;">NA</span><span style="color: #949494;">, </span><span style="color: #BB0000;">NA</span><span style="color: #949494;">, </span><span style="color: #BB0000;">NA</span><span style="color: #949494;">, </span><span style="color: #BB0000;">NA</span><span style="color: #949494;">, </span><span style="color: #BB0000;">NA</span><span style="color: #949494;">, </span><span style="color: #BB0000;">NA</span><span style="color: #949494;">, </span><span style="color: #BB0000;">NA</span>…</span></span>
<span><span class="co">## $ generation          <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 0<span style="color: #949494;">, </span>0<span style="color: #949494;">, </span>0<span style="color: #949494;">, </span>0<span style="color: #949494;">, </span>0<span style="color: #949494;">, </span>0<span style="color: #949494;">, </span>0<span style="color: #949494;">, </span>0<span style="color: #949494;">, </span>0<span style="color: #949494;">, </span>0<span style="color: #949494;">, </span>0<span style="color: #949494;">, </span>0<span style="color: #949494;">, </span>0<span style="color: #949494;">, </span>0<span style="color: #949494;">, </span>0<span style="color: #949494;">, </span>0<span style="color: #949494;">, </span>0<span style="color: #949494;">,</span>…</span></span>
<span><span class="co">## $ sequencing          <span style="color: #949494; font-style: italic;">&lt;lgl&gt;</span> TRUE<span style="color: #949494;">, </span>FALSE<span style="color: #949494;">, </span>TRUE<span style="color: #949494;">, </span>TRUE<span style="color: #949494;">, </span>TRUE<span style="color: #949494;">, </span>FALSE<span style="color: #949494;">, </span>FALSE<span style="color: #949494;">, </span>FALSE…</span></span>
<span><span class="co">## $ sequencing_delay    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 3.517302<span style="color: #949494;">, </span><span style="color: #BB0000;">NA</span><span style="color: #949494;">, </span>3.784284<span style="color: #949494;">, </span>2.663066<span style="color: #949494;">, </span>2.131584<span style="color: #949494;">, </span><span style="color: #BB0000;">NA</span><span style="color: #949494;">, </span><span style="color: #BB0000;">NA</span>…</span></span>
<span><span class="co">## $ sequencing_time     <span style="color: #949494; font-style: italic;">&lt;time_prd&gt;</span> 3.517302<span style="color: #949494;">, </span><span style="color: #BB0000;">NA</span><span style="color: #949494;">, </span>3.784284<span style="color: #949494;">, </span>2.663066<span style="color: #949494;">, </span>2.131584<span style="color: #949494;">, </span><span style="color: #BB0000;">N</span>…</span></span></code></pre>
<p>With this additional date we can summarise both time points into
daily counts of infections, and in this case “sequencing” samples, which
shows some periodicity as a result of the extended delay over the
weekend. However it is common to also have some sort of delay reporting
the results of a test. In this case we have added a longish delay in
getting the results back. As we are aggregating on sample date we will
therefore have a right censoring effect on positive sample counts.</p>
<div class="sourceCode" id="cb52"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">summary</span> <span class="op">=</span> <span class="va">linelist2</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="../reference/sim_summarise_linelist.html">sim_summarise_linelist</a></span><span class="op">(</span></span>
<span>    censoring <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      <span class="st">"sequencing"</span> <span class="op">=</span> <span class="op">~</span> <span class="fu"><a href="../reference/rgamma2.html">rgamma2</a></span><span class="op">(</span><span class="va">.x</span>, mean <span class="op">=</span> <span class="fl">14</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># plot the counts for comparison.</span></span>
<span><span class="va">p1</span><span class="op">=</span><span class="fu">plot_changes</span><span class="op">(</span><span class="va">summary</span>,<span class="st">"Rt"</span>,max_y <span class="op">=</span> <span class="fl">2.0</span>, case <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">p2</span><span class="op">=</span><span class="fu"><a href="../reference/plot_counts.html">plot_counts</a></span><span class="op">(</span><span class="va">summary</span>,events <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">summary</span>,<span class="st">"events"</span><span class="op">)</span>, mapping<span class="op">=</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>colour<span class="op">=</span><span class="va">statistic</span><span class="op">)</span>,size<span class="op">=</span><span class="fl">0.5</span><span class="op">)</span><span class="op">+</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">patchwork</span><span class="fu">::</span><span class="fu"><a href="https://patchwork.data-imaginist.com/reference/wrap_plots.html" class="external-link">wrap_plots</a></span><span class="op">(</span><span class="va">p1</span>,<span class="va">p2</span>,ncol<span class="op">=</span><span class="fl">1</span>,axes<span class="op">=</span><span class="st">"collect"</span><span class="op">)</span></span></code></pre></div>
<p><img src="simulation-test-models_files/figure-html/unnamed-chunk-26-1.png" width="700"></p>
</div>
<div class="section level3">
<h3 id="variant-introduction-alpha-example">Variant introduction: Alpha example<a class="anchor" aria-label="anchor" href="#variant-introduction-alpha-example"></a>
</h3>
<p>If the infectivity profile is changing dynamically over the
simulation it alters the relationship between reproduction number and
growth rate.</p>
<p>For line list models the infectivity profile could potentially vary
from individual to individual depending on the variant they are infected
with, which can be a cause of more rapid growth of a variant. It is hard
to differentiate between a higher reproduction number and a shorter
generation time, especially in the short term. However a decreased
generation time will lead to a steeper but flatter curve compared to an
increased
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>R</mi><mi>t</mi></msub><annotation encoding="application/x-tex">R_t</annotation></semantics></math>,
which will tend to take off more gradually, from the trajectory of the
original variant, but curve away more quickly as the higher exponential
rate kicks in.</p>
<div class="sourceCode" id="cb53"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">variant_imports_df</span> <span class="op">=</span> <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tribble.html" class="external-link">tribble</a></span><span class="op">(</span></span>
<span>  <span class="op">~</span><span class="va">time</span>, <span class="op">~</span><span class="va">variant</span>, <span class="op">~</span><span class="va">count</span>,</span>
<span>  <span class="fl">0</span><span class="op">:</span><span class="fl">4</span>, <span class="st">"wild-type"</span>, <span class="fl">5</span>,</span>
<span>  <span class="fl">20</span><span class="op">:</span><span class="fl">24</span>, <span class="st">"alpha"</span>, <span class="fl">5</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># The fist scenario is a two variant outbreak with one variant with a shorter</span></span>
<span><span class="co"># generation time.</span></span>
<span></span>
<span><span class="va">variant_ip_fn</span> <span class="op">=</span> <span class="fu"><a href="../reference/cfg_gamma_ip_fn.html">cfg_gamma_ip_fn</a></span><span class="op">(</span></span>
<span>    mean_fn <span class="op">=</span> \<span class="op">(</span><span class="va">variant</span><span class="op">)</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>      <span class="co"># Two infectivity profiles one for each variant.</span></span>
<span>      <span class="va">variant</span><span class="op">==</span><span class="st">"wild-type"</span> <span class="op">~</span> <span class="fl">8</span>,</span>
<span>      <span class="va">variant</span><span class="op">==</span><span class="st">"alpha"</span> <span class="op">~</span> <span class="fl">5</span><span class="op">)</span> <span class="co"># variant 2 has a shorter generation time</span></span>
<span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">scenario1</span> <span class="op">=</span> <span class="fu"><a href="../reference/sim_branching_process.html">sim_branching_process</a></span><span class="op">(</span></span>
<span>  max_time <span class="op">=</span> <span class="fl">120</span>,</span>
<span>  fn_Rt <span class="op">=</span> <span class="op">~</span> <span class="fl">1.15</span>, <span class="co"># Both variants have the same fixed R_t</span></span>
<span>  fn_ip <span class="op">=</span> <span class="va">variant_ip_fn</span>,</span>
<span>  imports_df <span class="op">=</span> <span class="va">variant_imports_df</span>,</span>
<span>  seed<span class="op">=</span><span class="fl">101</span></span>
<span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## .........................complete</span></span></code></pre>
<div class="sourceCode" id="cb55"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># The second scenario involves two variants one with a slight reproduction </span></span>
<span><span class="co"># number advantage. Both have the same (longer) generation time</span></span>
<span></span>
<span><span class="va">variant_Rt_fn</span> <span class="op">=</span> \<span class="op">(</span><span class="va">t</span>,<span class="va">variant</span><span class="op">)</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>  <span class="va">variant</span><span class="op">==</span><span class="st">"wild-type"</span> <span class="op">~</span> <span class="fl">1.15</span>,</span>
<span>  <span class="va">variant</span><span class="op">==</span><span class="st">"alpha"</span> <span class="op">~</span> <span class="fl">1.3</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">scenario2</span> <span class="op">=</span> <span class="fu"><a href="../reference/sim_branching_process.html">sim_branching_process</a></span><span class="op">(</span></span>
<span>  max_time <span class="op">=</span> <span class="fl">120</span>,</span>
<span>  fn_Rt <span class="op">=</span> <span class="va">variant_Rt_fn</span>, </span>
<span>  fn_ip <span class="op">=</span> <span class="op">~</span> <span class="fu"><a href="../reference/make_gamma_ip.html">make_gamma_ip</a></span><span class="op">(</span><span class="fl">8</span><span class="op">)</span>, <span class="co"># Both variants have the same fixed ip with mean 8</span></span>
<span>  imports_df <span class="op">=</span> <span class="va">variant_imports_df</span>,</span>
<span>  seed<span class="op">=</span><span class="fl">100</span></span>
<span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## ....................complete</span></span></code></pre>
<div class="sourceCode" id="cb57"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">comparison</span> <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span></span>
<span>  <span class="va">scenario1</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="../reference/sim_summarise_linelist.html">sim_summarise_linelist</a></span><span class="op">(</span><span class="va">variant</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>scenario <span class="op">=</span> <span class="st">"1 - Shorter GT"</span><span class="op">)</span>,</span>
<span>  <span class="va">scenario2</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="../reference/sim_summarise_linelist.html">sim_summarise_linelist</a></span><span class="op">(</span><span class="va">variant</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>scenario <span class="op">=</span> <span class="st">"2 - Rt advantage"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Warning in interfacer::ireturn(out, i_sim_count_data): unexpected groups in the return value of sim_summarise_linelist(...):</span></span>
<span><span class="co">## observed: statistic+variant</span></span>
<span><span class="co">## expected: &lt;any&gt;+statistic</span></span>
<span><span class="co">## Warning in interfacer::ireturn(out, i_sim_count_data): unexpected groups in the return value of sim_summarise_linelist(...):</span></span>
<span><span class="co">## observed: statistic+variant</span></span>
<span><span class="co">## expected: &lt;any&gt;+statistic</span></span></code></pre>
<div class="sourceCode" id="cb59"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">p1</span><span class="op">=</span><span class="fu">plot_changes</span><span class="op">(</span><span class="va">comparison</span>,<span class="st">"Rt"</span>, max_y <span class="op">=</span> <span class="fl">2.5</span>,mapping <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>colour<span class="op">=</span><span class="va">variant</span><span class="op">)</span><span class="op">)</span><span class="op">+</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">scenario</span><span class="op">)</span></span>
<span><span class="va">p2</span><span class="op">=</span><span class="fu"><a href="../reference/plot_counts.html">plot_counts</a></span><span class="op">(</span><span class="va">comparison</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">scenario</span>,<span class="va">variant</span><span class="op">)</span>, mapping <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>colour<span class="op">=</span><span class="va">variant</span><span class="op">)</span><span class="op">)</span><span class="op">+</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">scenario</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">patchwork</span><span class="fu">::</span><span class="fu"><a href="https://patchwork.data-imaginist.com/reference/wrap_plots.html" class="external-link">wrap_plots</a></span><span class="op">(</span><span class="va">p1</span>,<span class="va">p2</span>,ncol<span class="op">=</span><span class="fl">1</span>,axes<span class="op">=</span><span class="st">"collect"</span><span class="op">)</span></span></code></pre></div>
<p><img src="simulation-test-models_files/figure-html/unnamed-chunk-27-1.png" width="700"></p>
</div>
<div class="section level3">
<h3 id="two-variants-delta-outbreak">Two variants: Delta outbreak<a class="anchor" aria-label="anchor" href="#two-variants-delta-outbreak"></a>
</h3>
<p>In the pandemic Delta started spreading whilst Alpha was declining.
This could not have been due to the generation time, which cannot change
the overall direction of the epidemic on its own. It must have been
associated with a more transmissible nature.</p>
<div class="sourceCode" id="cb60"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">variant_imports_df</span> <span class="op">=</span> <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tribble.html" class="external-link">tribble</a></span><span class="op">(</span></span>
<span>  <span class="op">~</span><span class="va">time</span>, <span class="op">~</span><span class="va">variant</span>, <span class="op">~</span><span class="va">count</span>,</span>
<span>  <span class="op">-</span><span class="fl">20</span><span class="op">:</span><span class="op">-</span><span class="fl">1</span>, <span class="st">"alpha"</span>, <span class="fl">300</span>,</span>
<span>  <span class="fl">15</span><span class="op">:</span><span class="fl">19</span>, <span class="st">"delta"</span>, <span class="fl">5</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">variant_Rt_fn</span> <span class="op">=</span> \<span class="op">(</span><span class="va">t</span>,<span class="va">variant</span><span class="op">)</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>  <span class="va">t</span> <span class="op">&lt;</span> <span class="fl">0</span> <span class="op">~</span> <span class="fl">0</span>,</span>
<span>  <span class="va">variant</span><span class="op">==</span><span class="st">"alpha"</span> <span class="op">~</span> <span class="fl">0.8</span>,</span>
<span>  <span class="va">variant</span><span class="op">==</span><span class="st">"delta"</span> <span class="op">~</span> <span class="fl">1.3</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">scenario</span> <span class="op">=</span> <span class="fu"><a href="../reference/sim_branching_process.html">sim_branching_process</a></span><span class="op">(</span></span>
<span>  max_time <span class="op">=</span> <span class="fl">120</span>,</span>
<span>  fn_Rt <span class="op">=</span> <span class="va">variant_Rt_fn</span>, </span>
<span>  fn_ip <span class="op">=</span> <span class="op">~</span> <span class="fu"><a href="../reference/make_gamma_ip.html">make_gamma_ip</a></span><span class="op">(</span><span class="fl">8</span><span class="op">)</span>, <span class="co"># Both variants have the same fixed ip with mean 8</span></span>
<span>  imports_df <span class="op">=</span> <span class="va">variant_imports_df</span>,</span>
<span>  seed<span class="op">=</span><span class="fl">100</span></span>
<span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## ...................complete</span></span></code></pre>
<div class="sourceCode" id="cb62"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">summary1</span> <span class="op">=</span>  <span class="va">scenario</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="../reference/sim_summarise_linelist.html">sim_summarise_linelist</a></span><span class="op">(</span><span class="va">variant</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">time</span> <span class="op">&gt;=</span> <span class="fl">0</span><span class="op">)</span> </span></code></pre></div>
<pre><code><span><span class="co">## Warning in interfacer::ireturn(out, i_sim_count_data): unexpected groups in the return value of sim_summarise_linelist(...):</span></span>
<span><span class="co">## observed: statistic+variant</span></span>
<span><span class="co">## expected: &lt;any&gt;+statistic</span></span></code></pre>
<div class="sourceCode" id="cb64"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">summary2</span> <span class="op">=</span>  <span class="va">scenario</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="../reference/sim_summarise_linelist.html">sim_summarise_linelist</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">time</span> <span class="op">&gt;=</span> <span class="fl">0</span><span class="op">)</span></span>
<span></span>
<span><span class="va">p1</span><span class="op">=</span><span class="fu"><a href="../reference/plot_counts.html">plot_counts</a></span><span class="op">(</span><span class="va">summary1</span>, mapping<span class="op">=</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>colour<span class="op">=</span><span class="va">variant</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">p2</span><span class="op">=</span><span class="fu"><a href="../reference/plot_counts.html">plot_counts</a></span><span class="op">(</span><span class="va">summary2</span><span class="op">)</span></span>
<span></span>
<span><span class="va">p3</span><span class="op">=</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">summary1</span>, <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="va">time</span><span class="op">)</span>, colour<span class="op">=</span><span class="va">variant</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>    <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y<span class="op">=</span><span class="va">rt.inst</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>    <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y<span class="op">=</span><span class="va">rt.weighted</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>    <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_cartesian.html" class="external-link">coord_cartesian</a></span><span class="op">(</span>ylim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">3.5</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>    <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="cn">NULL</span><span class="op">)</span></span>
<span></span>
<span><span class="va">p4</span><span class="op">=</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">summary2</span>, <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="va">time</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>    <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y<span class="op">=</span><span class="va">rt.inst</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>    <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y<span class="op">=</span><span class="va">rt.weighted</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>    <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_cartesian.html" class="external-link">coord_cartesian</a></span><span class="op">(</span>ylim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">3.5</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>    <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="cn">NULL</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">patchwork</span><span class="fu">::</span><span class="fu"><a href="https://patchwork.data-imaginist.com/reference/wrap_plots.html" class="external-link">wrap_plots</a></span><span class="op">(</span><span class="va">p1</span>,<span class="va">p2</span>,<span class="va">p3</span>,<span class="va">p4</span>,ncol<span class="op">=</span><span class="fl">2</span>,axes<span class="op">=</span><span class="st">"collect"</span><span class="op">)</span></span></code></pre></div>
<p><img src="simulation-test-models_files/figure-html/unnamed-chunk-28-1.png" width="700"></p>
</div>
<div class="section level3">
<h3 id="over-dispersion">Over-dispersion<a class="anchor" aria-label="anchor" href="#over-dispersion"></a>
</h3>
<p>In the branching process model, each infected individual has a daily
probability of infecting someone based on the current reproduction
number and the infectivity profile. This is sampled using either a
poisson or a negative binomial distribution depending on a dispersion
parameter (<code>kappa==1</code> is poisson distributed, anything larger
than this is a negative binomial). This can be made time dependent, so
that we can simulate changes in response to, for example, shutting
social venues. Very over-dispersed outbreaks have a higher chance of
becoming extinct in the early stage for the same reproduction number,
but this is not very realistic. More likely is a scenario where a subset
of the population have a high super-spreading potential.</p>
<div class="sourceCode" id="cb65"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">kappa</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1.5</span>,<span class="fl">2</span>,<span class="fl">3</span>,<span class="fl">4</span><span class="op">)</span></span>
<span></span>
<span><span class="va">comparison</span> <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">kappa</span>, <span class="kw">function</span><span class="op">(</span><span class="va">k</span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="fu"><a href="../reference/sim_branching_process.html">sim_branching_process</a></span><span class="op">(</span></span>
<span>    max_time <span class="op">=</span> <span class="fl">80</span>,</span>
<span>    fn_Rt <span class="op">=</span> <span class="op">~</span> <span class="fl">2</span>, <span class="co"># Both variants have the same fixed R_t</span></span>
<span>    fn_ip <span class="op">=</span> <span class="op">~</span> <span class="fu"><a href="../reference/make_gamma_ip.html">make_gamma_ip</a></span><span class="op">(</span><span class="fl">8</span><span class="op">)</span>,</span>
<span>    fn_import <span class="op">=</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">.x</span><span class="op">&lt;</span><span class="fl">10</span>,<span class="fl">4</span>,<span class="fl">0</span><span class="op">)</span>,</span>
<span>    fn_kappa <span class="op">=</span> <span class="op">~</span> <span class="va">k</span>,</span>
<span>    seed<span class="op">=</span><span class="fl">101</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="../reference/sim_summarise_linelist.html">sim_summarise_linelist</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>scenario <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"Dispersion: %1.2f"</span>,<span class="va">k</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span><span class="op">}</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## ................complete</span></span>
<span><span class="co">## ................complete</span></span>
<span><span class="co">## ...............complete</span></span>
<span><span class="co">## ................complete</span></span>
<span><span class="co">## ..............complete</span></span></code></pre>
<div class="sourceCode" id="cb67"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot_counts.html">plot_counts</a></span><span class="op">(</span><span class="va">comparison</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span>class<span class="op">=</span><span class="va">scenario</span><span class="op">)</span><span class="op">)</span><span class="op">+</span><span class="fu"><a href="../reference/scale_y_log1p.html">scale_y_log1p</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Scale for <span style="color: #00BB00;">y</span> is already present.</span></span>
<span><span class="co">## Adding another scale for <span style="color: #00BB00;">y</span>, which will replace the existing scale.</span></span></code></pre>
<p><img src="simulation-test-models_files/figure-html/unnamed-chunk-29-1.png" width="700"></p>
</div>
<div class="section level3">
<h3 id="age-stratification-contact-matrices">Age stratification &amp; contact matrices<a class="anchor" aria-label="anchor" href="#age-stratification-contact-matrices"></a>
</h3>
<p>We can specify metadata in the branching process model. In the
example above it was the variant, and was transmitted to the infectee.
If we can define a probabilistic mapping between metadata classes we can
simulate stratified populations such as by age. To do this we define a
function that reacts to the metadata and assigns a infectee class. We
also need to define the initial metadata for imported cases.</p>
<div class="sourceCode" id="cb69"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># This simulation is seeded in the younger age groups:</span></span>
<span><span class="va">strat_imports_df</span> <span class="op">=</span> <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tribble.html" class="external-link">tribble</a></span><span class="op">(</span></span>
<span>  <span class="op">~</span><span class="va">time</span>, <span class="op">~</span><span class="va">age_cat</span>, <span class="op">~</span><span class="va">count</span>,</span>
<span>  <span class="fl">0</span><span class="op">:</span><span class="fl">4</span>, <span class="st">"child"</span>, <span class="fl">5</span>,</span>
<span>  <span class="fl">0</span><span class="op">:</span><span class="fl">4</span>, <span class="st">"adolescent"</span>, <span class="fl">5</span></span>
<span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>age_cat <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">age_cat</span>,levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"child"</span>,<span class="st">"adolescent"</span>,<span class="st">"adult"</span>,<span class="st">"elderly"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># The next generation function in this form is similar to a </span></span>
<span><span class="co"># next generation matrix however it does not include R_t components: </span></span>
<span><span class="va">strat_fn_list_next_gen</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  <span class="st">"age_cat"</span> <span class="op">=</span> <span class="op">~</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>    <span class="va">.x</span> <span class="op">==</span> <span class="st">"child"</span> <span class="op">~</span> <span class="fu"><a href="../reference/rcategorical.html">rcategorical</a></span><span class="op">(</span><span class="va">.x</span>, prob <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"child"</span><span class="op">=</span><span class="fl">0.4</span>,<span class="st">"adolescent"</span><span class="op">=</span><span class="fl">0.2</span>,<span class="st">"adult"</span><span class="op">=</span><span class="fl">0.4</span>,<span class="st">"elderly"</span><span class="op">=</span><span class="fl">0</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    <span class="va">.x</span> <span class="op">==</span> <span class="st">"adolescent"</span> <span class="op">~</span> <span class="fu"><a href="../reference/rcategorical.html">rcategorical</a></span><span class="op">(</span><span class="va">.x</span>, prob <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"child"</span><span class="op">=</span><span class="fl">0.2</span>,<span class="st">"adolescent"</span><span class="op">=</span><span class="fl">0.4</span>,<span class="st">"adult"</span><span class="op">=</span><span class="fl">0.3</span>,<span class="st">"elderly"</span><span class="op">=</span><span class="fl">0.1</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    <span class="va">.x</span> <span class="op">==</span> <span class="st">"adult"</span> <span class="op">~</span> <span class="fu"><a href="../reference/rcategorical.html">rcategorical</a></span><span class="op">(</span><span class="va">.x</span>, prob <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"child"</span><span class="op">=</span><span class="fl">0.1</span>,<span class="st">"adolescent"</span><span class="op">=</span><span class="fl">0.1</span>,<span class="st">"adult"</span><span class="op">=</span><span class="fl">0.4</span>,<span class="st">"elderly"</span><span class="op">=</span><span class="fl">0.4</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    <span class="va">.x</span> <span class="op">==</span> <span class="st">"elderly"</span> <span class="op">~</span> <span class="fu"><a href="../reference/rcategorical.html">rcategorical</a></span><span class="op">(</span><span class="va">.x</span>, prob <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"child"</span><span class="op">=</span><span class="fl">0</span>,<span class="st">"adolescent"</span><span class="op">=</span><span class="fl">0.2</span>,<span class="st">"adult"</span><span class="op">=</span><span class="fl">0.3</span>,<span class="st">"elderly"</span><span class="op">=</span><span class="fl">0.5</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">strat_fn_Rt</span> <span class="op">=</span> \<span class="op">(</span><span class="va">age_cat</span><span class="op">)</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>  <span class="va">age_cat</span> <span class="op">==</span> <span class="st">"child"</span> <span class="op">~</span> <span class="fl">1.2</span>,</span>
<span>  <span class="va">age_cat</span> <span class="op">==</span> <span class="st">"adolescent"</span> <span class="op">~</span> <span class="fl">1.2</span>,</span>
<span>  <span class="va">age_cat</span> <span class="op">==</span> <span class="st">"adult"</span> <span class="op">~</span> <span class="fl">1.2</span>,</span>
<span>  <span class="va">age_cat</span> <span class="op">==</span> <span class="st">"elderly"</span> <span class="op">~</span> <span class="fl">2</span>,</span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">strat_bpm</span> <span class="op">=</span> <span class="fu"><a href="../reference/sim_branching_process.html">sim_branching_process</a></span><span class="op">(</span></span>
<span>    max_time <span class="op">=</span> <span class="fl">80</span>,</span>
<span>    fn_Rt <span class="op">=</span> <span class="va">strat_fn_Rt</span>,</span>
<span>    fn_ip <span class="op">=</span> <span class="op">~</span> <span class="fu"><a href="../reference/make_gamma_ip.html">make_gamma_ip</a></span><span class="op">(</span><span class="fl">8</span><span class="op">)</span>,</span>
<span>    imports_df <span class="op">=</span> <span class="va">strat_imports_df</span>,</span>
<span>    fn_list_next_gen <span class="op">=</span> <span class="va">strat_fn_list_next_gen</span>,</span>
<span>    seed<span class="op">=</span><span class="fl">101</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>age_cat <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">age_cat</span>,levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"child"</span>,<span class="st">"adolescent"</span>,<span class="st">"adult"</span>,<span class="st">"elderly"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## ................complete</span></span></code></pre>
<div class="sourceCode" id="cb71"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot_cases.html">plot_cases</a></span><span class="op">(</span><span class="va">strat_bpm</span>,mapping <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>fill<span class="op">=</span><span class="va">age_cat</span><span class="op">)</span>,individual<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span><span class="op">+</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_cartesian.html" class="external-link">coord_cartesian</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Coordinate system already present. Adding new coordinate system, which will</span></span>
<span><span class="co">## replace the existing one.</span></span></code></pre>
<p><img src="simulation-test-models_files/figure-html/unnamed-chunk-30-1.png" width="700"></p>
</div>
</div>
<div class="section level2">
<h2 id="future-steps">Future steps<a class="anchor" aria-label="anchor" href="#future-steps"></a>
</h2>
<div class="sourceCode" id="cb73"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#TODO: defaults in function that line up with sim_apply_delay_convolution</span></span>
<span><span class="co">#' # move this to vignette examples</span></span>
<span><span class="co">#' tmp2 = tmp %&gt;% sim_apply_delay(</span></span>
<span><span class="co">#'   fn_p_symptomatic = ~ 0.8,</span></span>
<span><span class="co">#'   fn_symptom_delay = ~ stats::rgamma(.x, shape = 3),</span></span>
<span><span class="co">#'   fn_p_tested = \(symptomatic,...) ifelse(symptomatic, 0.8, 0.1),</span></span>
<span><span class="co">#'   fn_sample_delay = ~ stats::rgamma(.x, shape = 2),</span></span>
<span><span class="co">#'   fn_result_delay = \(sample_time,...) dplyr::case_when(</span></span>
<span><span class="co">#'       floor(sample_time) %% 7 %in% c(0,1,2,3,4) ~ stats::rgamma(sample_time, shape=2), # Sun, Mon to Thurs</span></span>
<span><span class="co">#'       floor(sample_time) %% 7 == 5 ~ stats::rgamma(sample_time, shape=4), # Fri</span></span>
<span><span class="co">#'       floor(sample_time) %% 7 == 6 ~ stats::rgamma(sample_time, shape=3), # Sat</span></span>
<span><span class="co">#'   )</span></span>
<span><span class="co">#' )</span></span>
<span><span class="co">#' </span></span>
<span><span class="co">#' </span></span>
<span><span class="co">#' </span></span>
<span><span class="co">#' # Delay distribution example:</span></span>
<span><span class="co">#' tmp3 = sim_branching_process(</span></span>
<span><span class="co">#'   changes = tibble::tibble(t = c(0,20,40,60,80,110), R_t = c(1.8,1.5,0.9,1.5,0.8,1.2)),</span></span>
<span><span class="co">#'   kappa = 1,</span></span>
<span><span class="co">#'   max_time = 120,</span></span>
<span><span class="co">#'   seed = 100,</span></span>
<span><span class="co">#'   summarise = FALSE</span></span>
<span><span class="co">#'  ) %&gt;% sim_apply_delay(</span></span>
<span><span class="co">#'   fn_p_symptomatic = ~ 0.8,</span></span>
<span><span class="co">#'   fn_symptom_delay = ~ stats::rgamma(.x, shape = 3),</span></span>
<span><span class="co">#'   fn_p_symptomatic = ~ 0.8,</span></span>
<span><span class="co">#'   fn_symptom_delay = ~ stats::rgamma(.x, shape = 3),</span></span>
<span><span class="co">#'   fn_p_tested = \(symptomatic,...) ifelse(symptomatic, 0.8, 0.1),</span></span>
<span><span class="co">#'   fn_sample_delay = \(symptomatic, symptom_time, ...) dplyr::case_when(</span></span>
<span><span class="co">#'       !symptomatic ~ stats::runif(symptomatic, max = 14),</span></span>
<span><span class="co">#'       TRUE ~ cfg_weekly_gamma_rng(c(1,1,1,1,3,2,2))(symptom_time)</span></span>
<span><span class="co">#'   ),</span></span>
<span><span class="co">#'   fn_result_delay = \(sample_time,...) cfg_weekly_gamma_rng(c(1,1,1,1,3,2,2))(sample_time)</span></span>
<span><span class="co">#'  )</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' tmp4 = tmp3 %&gt;% sim_summarise_linelist()</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' ggplot2::ggplot(tmp4 %&gt;% dplyr::filter(!is.na(count)), ggplot2::aes(x=time, colour=statistic))+</span></span>
<span><span class="co">#'   ggplot2::geom_line(ggplot2::aes(y=count))+</span></span>
<span><span class="co">#'   ggplot2::facet_wrap(~statistic,ncol=1)</span></span>
<span><span class="co">#' }</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' #' tmp2 = sim_branching_process(</span></span>
<span><span class="co">#'   changes = tibble::tibble(t = c(0,20,40,60,80,110), R = c(1.8,1.5,0.9,1.5,0.8,1.2)),</span></span>
<span><span class="co">#'   kappa = 1,</span></span>
<span><span class="co">#'   max_time = 120,</span></span>
<span><span class="co">#'   seed = 100</span></span>
<span><span class="co">#' ) %&gt;% sim_summarise_linelist()</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' ggplot2::ggplot(tmp2, ggplot2::aes(x=time))+</span></span>
<span><span class="co">#'   ggplot2::geom_point(ggplot2::aes(y=count))+</span></span>
<span><span class="co">#'   ggplot2::geom_line(ggplot2::aes(y=original))</span></span>
<span><span class="co">#'</span></span>
<span><span class="co"># ggplot2::ggplot(tmp2, ggplot2::aes(x=time))+</span></span>
<span><span class="co">#    ggplot2::geom_step(ggplot2::aes(y=rt.weighted), colour="black")+</span></span>
<span><span class="co">#    ggplot2::geom_point(ggplot2::aes(y=rt.inst, colour="Instantaneous"))+</span></span>
<span><span class="co">#    ggplot2::geom_point(ggplot2::aes(y=rt.case, colour="Case"))+</span></span>
<span><span class="co">#    ggplot2::coord_cartesian(ylim=c(0,3))</span></span></code></pre></div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Robert Challen.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
