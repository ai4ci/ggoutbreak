<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Estimating the reproduction number from modelled incidence • ggoutbreak</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Estimating the reproduction number from modelled incidence">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">ggoutbreak</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.4.1</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/covid-timeseries.html">England COVID-19 cases</a></li>
    <li><a class="dropdown-item" href="../articles/estimators-example.html">Simulation tests for growth rate estimators</a></li>
    <li><a class="dropdown-item" href="../articles/incidence-trends.html">Population comparisons and incidence</a></li>
    <li><a class="dropdown-item" href="../articles/infectivity-profile-discretisation.html">Infectivity profile discretisation</a></li>
    <li><a class="dropdown-item" href="../articles/rt-from-incidence.html">Estimating the reproduction number from modelled incidence</a></li>
    <li><a class="dropdown-item" href="../articles/sampling-serial-interval.html">Sampling the infectivity profile from published serial interval estimates</a></li>
    <li><a class="dropdown-item" href="../articles/simulation-test-models.html">Simulations and test harnesses</a></li>
    <li><a class="dropdown-item" href="../articles/time-periods.html">Data wrangling and working with `ggoutbreak`</a></li>
    <li><a class="dropdown-item" href="../articles/time-units.html">Estimating the reproduction number from weekly data</a></li>
    <li><a class="dropdown-item" href="../articles/variant-proportions.html">Multinomial proportions models for genomic variants</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/ai4ci/ggoutbreak/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Estimating the reproduction number from modelled incidence</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/ai4ci/ggoutbreak/blob/HEAD/vignettes/rt-from-incidence.Rmd" class="external-link"><code>vignettes/rt-from-incidence.Rmd</code></a></small>
      <div class="d-none name"><code>rt-from-incidence.Rmd</code></div>
    </div>

    
    
<p>Robert Challen <sup>1,2</sup>; Leon Danon <sup>1,2</sup>;</p>
<ol style="list-style-type: decimal">
<li>Engineering Mathematics, University of Bristol, Bristol, UK</li>
<li>AI4CI</li>
</ol>
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>If we have estimated the incidence of a disease
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>I</mi><mi>t</mi></msub><annotation encoding="application/x-tex">I_t</annotation></semantics></math>
using a poisson rate using maximum likelihood estimators, the rate is
typically a log-normally distributed with parameters
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>μ</mi><annotation encoding="application/x-tex">\mu</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>σ</mi><annotation encoding="application/x-tex">\sigma</annotation></semantics></math>.
Such a fitted model is shown below on a log1p scale, for the COVID-19
epidemic in England:</p>
<p><img src="rt-from-incidence_files/figure-html/unnamed-chunk-1-1.png" width="700"></p>
<p>It is appealing to use this modelled incidence estimate to calculate
an estimate of the reproduction number,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>R</mi><mi>t</mi></msub><annotation encoding="application/x-tex">R_t</annotation></semantics></math>.
Incidence models can be derived in a number of ways, they are easily
inspected for error and can be made tolerant of missing values and
outliers.</p>
</div>
<div class="section level2">
<h2 id="methods">Methods<a class="anchor" aria-label="anchor" href="#methods"></a>
</h2>
<p>To use a modelled estimate of incidence to predict
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>R</mi><mi>t</mi></msub><annotation encoding="application/x-tex">R_t</annotation></semantics></math>
we need to propagate uncertainty in incidence into our
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>R</mi><mi>t</mi></msub><annotation encoding="application/x-tex">R_t</annotation></semantics></math>
estimates. To calculate
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>R</mi><mi>t</mi></msub><annotation encoding="application/x-tex">R_t</annotation></semantics></math>
we can use the backwards-looking renewal equations which incorporate the
infectivity profile of the disease
(<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>ω</mi><annotation encoding="application/x-tex">\omega</annotation></semantics></math>)
at a number of days after infection
(<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>τ</mi><annotation encoding="application/x-tex">\tau</annotation></semantics></math>):</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable><mtr><mtd columnalign="right" style="text-align: right"><msub><mi>I</mi><mi>t</mi></msub></mtd><mtd columnalign="left" style="text-align: left"><mo>∼</mo><mi>L</mi><mi>o</mi><mi>g</mi><mi>n</mi><mi>o</mi><mi>r</mi><mi>m</mi><mi>a</mi><mi>l</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>μ</mi><mi>t</mi></msub><mo>,</mo><msub><mi>σ</mi><mi>t</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow></mtd></mtr><mtr><mtd columnalign="right" style="text-align: right"><msub><mi>R</mi><mi>t</mi></msub></mtd><mtd columnalign="left" style="text-align: left"><mo>=</mo><mfrac><msub><mi>I</mi><mi>t</mi></msub><mrow><munder><mo>∑</mo><mi>τ</mi></munder><mrow><msub><mi>ω</mi><mi>τ</mi></msub><msub><mi>I</mi><mrow><mi>t</mi><mo>−</mo><mi>τ</mi></mrow></msub></mrow></mrow></mfrac></mtd></mtr></mtable><annotation encoding="application/x-tex">
\begin{align}
I_t &amp;\sim Lognormal(\mu_t,\sigma_t) \\
R_t &amp;= \frac{I_t}{\sum_{\tau}{\omega_{\tau}I_{t-\tau}}}
\end{align}
</annotation></semantics></math></p>
<p>giving us:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable><mtr><mtd columnalign="right" style="text-align: right"><msub><mi>R</mi><mi>t</mi></msub><mo>=</mo><mfrac><mrow><mi>L</mi><mi>o</mi><mi>g</mi><mi>n</mi><mi>o</mi><mi>r</mi><mi>m</mi><mi>a</mi><mi>l</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>μ</mi><mi>t</mi></msub><mo>,</mo><msub><mi>σ</mi><mi>t</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><mrow><munder><mo>∑</mo><mi>τ</mi></munder><mrow><mi>L</mi><mi>o</mi><mi>g</mi><mi>n</mi><mi>o</mi><mi>r</mi><mi>m</mi><mi>a</mi><mi>l</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>μ</mi><mrow><mi>t</mi><mo>−</mo><mi>τ</mi></mrow></msub><mo>+</mo><mi>l</mi><mi>o</mi><mi>g</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>ω</mi><mi>τ</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow><mo>,</mo><msub><mi>σ</mi><mrow><mi>t</mi><mo>−</mo><mi>τ</mi></mrow></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow></mrow></mfrac></mtd></mtr></mtable><annotation encoding="application/x-tex">
\begin{align}
R_t = \frac{Lognormal(\mu_t,\sigma_t)}{\sum_{\tau}{
  Lognormal( \mu_{t-\tau} + log(\omega_{\tau}) , \sigma_{t-\tau})
}}
\end{align}
</annotation></semantics></math></p>
<p>The sum of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>i</mi><annotation encoding="application/x-tex">i</annotation></semantics></math>
such log normal distributions can be approximated by another log normal
(Lo 2013) with parameters
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>μ</mi><mi>Z</mi></msub><annotation encoding="application/x-tex">\mu_Z</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>σ</mi><mi>Z</mi></msub><annotation encoding="application/x-tex">\sigma_Z</annotation></semantics></math>.</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable><mtr><mtd columnalign="right" style="text-align: right"><msub><mi>S</mi><mo>+</mo></msub></mtd><mtd columnalign="left" style="text-align: left"><mo>=</mo><mo>E</mo><mrow><mo stretchy="true" form="prefix">[</mo><munder><mo>∑</mo><mi>i</mi></munder><msub><mi>X</mi><mi>i</mi></msub><mo stretchy="true" form="postfix">]</mo></mrow><mo>=</mo><munder><mo>∑</mo><mi>i</mi></munder><mo>E</mo><mrow><mo stretchy="true" form="prefix">[</mo><msub><mi>X</mi><mi>i</mi></msub><mo stretchy="true" form="postfix">]</mo></mrow><mo>=</mo><munder><mo>∑</mo><mi>i</mi></munder><msup><mi>e</mi><mrow><msub><mi>μ</mi><mi>i</mi></msub><mo>+</mo><mfrac><mn>1</mn><mn>2</mn></mfrac><msubsup><mi>σ</mi><mi>i</mi><mn>2</mn></msubsup></mrow></msup></mtd></mtr><mtr><mtd columnalign="right" style="text-align: right"><msubsup><mi>σ</mi><mi>Z</mi><mn>2</mn></msubsup></mtd><mtd columnalign="left" style="text-align: left"><mo>=</mo><mfrac><mn>1</mn><msubsup><mi>S</mi><mo>+</mo><mn>2</mn></msubsup></mfrac><mspace width="0.167em"></mspace><munder><mo>∑</mo><mrow><mi>i</mi><mo>,</mo><mi>j</mi></mrow></munder><msub><mo>cor</mo><mrow><mi>i</mi><mi>j</mi></mrow></msub><msub><mi>σ</mi><mi>i</mi></msub><msub><mi>σ</mi><mi>j</mi></msub><mo>E</mo><mrow><mo stretchy="true" form="prefix">[</mo><msub><mi>X</mi><mi>i</mi></msub><mo stretchy="true" form="postfix">]</mo></mrow><mo>E</mo><mrow><mo stretchy="true" form="prefix">[</mo><msub><mi>X</mi><mi>j</mi></msub><mo stretchy="true" form="postfix">]</mo></mrow><mo>=</mo><mfrac><mn>1</mn><msubsup><mi>S</mi><mo>+</mo><mn>2</mn></msubsup></mfrac><mspace width="0.167em"></mspace><munder><mo>∑</mo><mrow><mi>i</mi><mo>,</mo><mi>j</mi></mrow></munder><msub><mo>cor</mo><mrow><mi>i</mi><mi>j</mi></mrow></msub><msub><mi>σ</mi><mi>i</mi></msub><msub><mi>σ</mi><mi>j</mi></msub><msup><mi>e</mi><mrow><msub><mi>μ</mi><mi>i</mi></msub><mo>+</mo><mfrac><mn>1</mn><mn>2</mn></mfrac><msubsup><mi>σ</mi><mi>i</mi><mn>2</mn></msubsup></mrow></msup><msup><mi>e</mi><mrow><msub><mi>μ</mi><mi>j</mi></msub><mo>+</mo><mfrac><mn>1</mn><mn>2</mn></mfrac><msubsup><mi>σ</mi><mi>j</mi><mn>2</mn></msubsup></mrow></msup></mtd></mtr><mtr><mtd columnalign="right" style="text-align: right"><msub><mi>μ</mi><mi>Z</mi></msub></mtd><mtd columnalign="left" style="text-align: left"><mo>=</mo><mo>ln</mo><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>S</mi><mo>+</mo></msub><mo stretchy="true" form="postfix">)</mo></mrow><mo>−</mo><mfrac><mn>1</mn><mn>2</mn></mfrac><msubsup><mi>σ</mi><mi>Z</mi><mn>2</mn></msubsup></mtd></mtr></mtable><annotation encoding="application/x-tex">
\begin{align}
    S_+ &amp;= \operatorname{E}\left[\sum_i X_i \right] = \sum_i 
    \operatorname{E}[X_i] = 
    \sum_i e^{\mu_i + \frac{1}{2}\sigma_i^2}
    \\
    \sigma^2_{Z} &amp;= \frac{1}{S_+^2} \, \sum_{i,j}
      \operatorname{cor}_{ij} \sigma_i \sigma_j \operatorname{E}[X_i] \operatorname{E}[X_j] =
      \frac{1}{S_+^2} \, \sum_{i,j}
      \operatorname{cor}_{ij} \sigma_i \sigma_j e^{\mu_i+\frac{1}{2}\sigma_i^2} 
      e^{\mu_j+\frac{1}{2}\sigma_j^2} 
    \\
    \mu_Z &amp;= \ln\left( S_+ \right) - \frac{1}{2}\sigma_{Z}^2 
\end{align}
</annotation></semantics></math></p>
<p>The sum term in the denominator of the renewal equations consists of
a set of correlated scaled log normal distributions with both scale and
correlation defined by the infectivity profile
(<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>ω</mi><annotation encoding="application/x-tex">\omega</annotation></semantics></math>).
In our case
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>c</mi><mi>o</mi><msub><mi>r</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub></mrow><annotation encoding="application/x-tex">cor_{ij}</annotation></semantics></math>
can be equated to the infectivity profile
(<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>ω</mi><mrow><mo stretchy="true" form="prefix">|</mo><mi>i</mi><mo>−</mo><mi>j</mi><mo stretchy="true" form="postfix">|</mo></mrow></msub><annotation encoding="application/x-tex">\omega_{|i-j|}</annotation></semantics></math>)
when
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi><mo>≠</mo><mi>j</mi></mrow><annotation encoding="application/x-tex">i \neq j</annotation></semantics></math>
and 1 when
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi><mo>=</mo><mi>j</mi></mrow><annotation encoding="application/x-tex">i = j</annotation></semantics></math>.
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>μ</mi><mi>i</mi></msub><annotation encoding="application/x-tex">\mu_i</annotation></semantics></math>
is
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>μ</mi><mrow><mi>t</mi><mo>−</mo><mi>τ</mi></mrow></msub><mo>+</mo><mi>l</mi><mi>n</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>ω</mi><mi>τ</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\mu_{t-\tau} + ln(\omega_{\tau})</annotation></semantics></math>.</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable><mtr><mtd columnalign="right" style="text-align: right"><msub><mi>S</mi><mi>t</mi></msub></mtd><mtd columnalign="left" style="text-align: left"><mo>=</mo><munderover><mo>∑</mo><mrow><mi>s</mi><mo>=</mo><mn>1</mn></mrow><mrow><mo stretchy="true" form="prefix">|</mo><mi>ω</mi><mo stretchy="true" form="postfix">|</mo></mrow></munderover><mrow><msub><mi>ω</mi><mi>s</mi></msub><msup><mi>e</mi><mrow><msub><mi>μ</mi><mrow><mi>t</mi><mo>−</mo><mi>s</mi></mrow></msub><mo>+</mo><mfrac><mn>1</mn><mn>2</mn></mfrac><msubsup><mi>σ</mi><mrow><mi>t</mi><mo>−</mo><mi>s</mi></mrow><mn>2</mn></msubsup></mrow></msup></mrow></mtd></mtr><mtr><mtd columnalign="right" style="text-align: right"><msub><mi>σ</mi><mrow><mi>Z</mi><mo>,</mo><mi>t</mi></mrow></msub></mtd><mtd columnalign="left" style="text-align: left"><mo>=</mo><msqrt><mfrac><mrow><munderover><mo>∑</mo><mrow><mi>i</mi><mo>,</mo><mi>j</mi><mo>=</mo><mn>1</mn></mrow><mrow><mo stretchy="true" form="prefix">|</mo><mi>ω</mi><mo stretchy="true" form="postfix">|</mo></mrow></munderover><mrow><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>ω</mi><mrow><mo stretchy="true" form="prefix">|</mo><mi>i</mi><mo>−</mo><mi>j</mi><mo stretchy="true" form="postfix">|</mo></mrow></msub><mo>+</mo><mi>I</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>i</mi><mo>,</mo><mi>j</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">)</mo></mrow><msub><mi>ω</mi><mi>i</mi></msub><msub><mi>ω</mi><mi>j</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>σ</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo>−</mo><mi>i</mi><mo stretchy="true" form="postfix">)</mo></mrow></msub><msup><mi>e</mi><mrow><msub><mi>μ</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo>−</mo><mi>i</mi><mo stretchy="true" form="postfix">)</mo></mrow></msub><mo>+</mo><mfrac><mn>1</mn><mn>2</mn></mfrac><msubsup><mi>σ</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo>−</mo><mi>i</mi><mo stretchy="true" form="postfix">)</mo></mrow><mn>2</mn></msubsup></mrow></msup><mo stretchy="true" form="postfix">)</mo></mrow><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>σ</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo>−</mo><mi>j</mi><mo stretchy="true" form="postfix">)</mo></mrow></msub><msup><mi>e</mi><mrow><msub><mi>μ</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo>−</mo><mi>j</mi><mo stretchy="true" form="postfix">)</mo></mrow></msub><mo>+</mo><mfrac><mn>1</mn><mn>2</mn></mfrac><msubsup><mi>σ</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo>−</mo><mi>j</mi><mo stretchy="true" form="postfix">)</mo></mrow><mn>2</mn></msubsup></mrow></msup><mo stretchy="true" form="postfix">)</mo></mrow></mrow></mrow><msubsup><mi>S</mi><mi>t</mi><mn>2</mn></msubsup></mfrac></msqrt></mtd></mtr><mtr><mtd columnalign="right" style="text-align: right"><msub><mi>μ</mi><mrow><mi>Z</mi><mo>,</mo><mi>t</mi></mrow></msub></mtd><mtd columnalign="left" style="text-align: left"><mo>=</mo><mo>log</mo><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>S</mi><mi>t</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow><mo>−</mo><mfrac><mn>1</mn><mn>2</mn></mfrac><msubsup><mi>σ</mi><mrow><mi>Z</mi><mo>,</mo><mi>t</mi></mrow><mn>2</mn></msubsup></mtd></mtr></mtable><annotation encoding="application/x-tex">
\begin{align}
    S_{t} &amp;= \sum_{s=1}^{|\omega|} { \omega_s e^{\mu_{t-s} + \frac{1}{2}\sigma_{t-s}^2 }} \\
    \sigma_{Z,t} &amp;= \sqrt{
      \frac{
        \sum_{i,j=1}^{|\omega|} {
        (\omega_{|i-j|}+I(i,j)) \omega_i \omega_j (\sigma_{(t-i)} e^{\mu_{(t-i)}+\frac{1}{2}\sigma_{(t-i)}^2}) (\sigma_{(t-j)} e^{\mu_{(t-j)}+\frac{1}{2}\sigma_{(t-j)}^2}) 
        }
      }{S_{t}^2}
    }   \\
    \mu_{Z,t} &amp;= \log\left( S_{t} \right) - \frac{1}{2}\sigma_{Z,t}^2 
\end{align}
</annotation></semantics></math></p>
<p><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>μ</mi><annotation encoding="application/x-tex">\mu</annotation></semantics></math>
is the central estimate of case counts on the log scale, and its
standard deviation can also be large. There are numerical stability
issues dealing with terms involving
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msup><mi>e</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>μ</mi><mo>+</mo><msup><mi>σ</mi><mn>2</mn></msup><mo stretchy="true" form="postfix">)</mo></mrow></msup><annotation encoding="application/x-tex">e^{(\mu+\sigma^2)}</annotation></semantics></math>,
however keeping everything in log space and using optimised log-sum-exp
functions this can be made computationally tractable.</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable><mtr><mtd columnalign="right" style="text-align: right"><mo>log</mo><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>S</mi><mi>t</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow></mtd><mtd columnalign="left" style="text-align: left"><mo>=</mo><mo>log</mo><mrow><mo stretchy="true" form="prefix">(</mo><munderover><mo>∑</mo><mrow><mi>s</mi><mo>=</mo><mn>1</mn></mrow><mrow><mo stretchy="true" form="prefix">|</mo><mi>ω</mi><mo stretchy="true" form="postfix">|</mo></mrow></munderover><msup><mi>e</mi><mrow><msub><mi>μ</mi><mrow><mi>t</mi><mo>−</mo><mi>s</mi></mrow></msub><mo>+</mo><mfrac><mn>1</mn><mn>2</mn></mfrac><msubsup><mi>σ</mi><mrow><mi>t</mi><mo>−</mo><mi>s</mi></mrow><mn>2</mn></msubsup><mo>+</mo><mo>log</mo><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>ω</mi><mi>s</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow></msup><mo stretchy="true" form="postfix">)</mo></mrow></mtd></mtr><mtr><mtd columnalign="right" style="text-align: right"><mo>log</mo><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>T</mi><mrow><mi>t</mi><mo>,</mo><mi>τ</mi></mrow></msub><mo stretchy="true" form="postfix">)</mo></mrow></mtd><mtd columnalign="left" style="text-align: left"><mo>=</mo><mo>log</mo><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>ω</mi><mi>τ</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow><mo>+</mo><mo>log</mo><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>σ</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo>−</mo><mi>τ</mi><mo stretchy="true" form="postfix">)</mo></mrow></msub><mo stretchy="true" form="postfix">)</mo></mrow><mo>+</mo><msub><mi>μ</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo>−</mo><mi>τ</mi><mo stretchy="true" form="postfix">)</mo></mrow></msub><mo>+</mo><mfrac><mn>1</mn><mn>2</mn></mfrac><msubsup><mi>σ</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo>−</mo><mi>τ</mi><mo stretchy="true" form="postfix">)</mo></mrow><mn>2</mn></msubsup><mo stretchy="false" form="postfix">)</mo></mtd></mtr><mtr><mtd columnalign="right" style="text-align: right"><mo>log</mo><mrow><mo stretchy="true" form="prefix">(</mo><mi>c</mi><mi>o</mi><msub><mi>r</mi><mrow><mi>i</mi><mo>,</mo><mi>j</mi></mrow></msub><mo stretchy="true" form="postfix">)</mo></mrow></mtd><mtd columnalign="left" style="text-align: left"><mo>=</mo><mo>log</mo><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>ω</mi><mrow><mo stretchy="true" form="prefix">|</mo><mi>i</mi><mo>−</mo><mi>j</mi><mo stretchy="true" form="postfix">|</mo></mrow></msub><mo>+</mo><mi>I</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>i</mi><mo>=</mo><mi>j</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">)</mo></mrow></mtd></mtr><mtr><mtd columnalign="right" style="text-align: right"><mo>log</mo><mrow><mo stretchy="true" form="prefix">(</mo><msubsup><mi>σ</mi><mrow><mi>Z</mi><mo>,</mo><mi>t</mi></mrow><mn>2</mn></msubsup><mo stretchy="true" form="postfix">)</mo></mrow></mtd><mtd columnalign="left" style="text-align: left"><mo>=</mo><mo>log</mo><mrow><mo stretchy="true" form="prefix">(</mo><munderover><mo>∑</mo><mrow><mi>i</mi><mo>,</mo><mi>j</mi><mo>=</mo><mn>1</mn></mrow><mrow><mo stretchy="true" form="prefix">|</mo><mi>ω</mi><mo stretchy="true" form="postfix">|</mo></mrow></munderover><msup><mi>e</mi><mrow><mo>log</mo><mrow><mo stretchy="true" form="prefix">(</mo><mi>c</mi><mi>o</mi><msub><mi>r</mi><mrow><mi>i</mi><mo>,</mo><mi>j</mi></mrow></msub><mo stretchy="true" form="postfix">)</mo></mrow><mo>+</mo><mo>log</mo><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>T</mi><mrow><mi>t</mi><mo>,</mo><mi>i</mi></mrow></msub><mo stretchy="true" form="postfix">)</mo></mrow><mo>+</mo><mo>log</mo><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>T</mi><mrow><mi>t</mi><mo>,</mo><mi>j</mi></mrow></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow></msup><mo stretchy="true" form="postfix">)</mo></mrow><mo>−</mo><mn>2</mn><mo>log</mo><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>S</mi><mi>t</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow></mtd></mtr><mtr><mtd columnalign="right" style="text-align: right"><msub><mi>μ</mi><mrow><mi>Z</mi><mo>,</mo><mi>t</mi></mrow></msub></mtd><mtd columnalign="left" style="text-align: left"><mo>=</mo><mo>log</mo><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>S</mi><mi>t</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow><mo>−</mo><mfrac><mn>1</mn><mn>2</mn></mfrac><msubsup><mi>σ</mi><mrow><mi>Z</mi><mo>,</mo><mi>t</mi></mrow><mn>2</mn></msubsup></mtd></mtr></mtable><annotation encoding="application/x-tex">
\begin{align}
    \log(S_{t}) &amp;= \log(\sum_{s=1}^{|\omega|} {  e^{\mu_{t-s} + \frac{1}{2}\sigma_{t-s}^2 + \log(\omega_s) }}) \\
    \log(T_{t,\tau}) &amp;= \log(\omega_{\tau}) + \log(\sigma_{(t-{\tau})}) + \mu_{(t-{\tau})} + \frac{1}{2}\sigma_{(t-{\tau})}^2) \\
    \log(cor_{i,j}) &amp;= \log(\omega_{|i-j|}+I(i=j)) \\
    \log(\sigma_{Z,t}^2) &amp;= \log(
        \sum_{i,j=1}^{|\omega|} {
          e^{
            \log(cor_{i,j}) + \log(T_{t,i}) + \log(T_{t,j})
          }
        }) - 2 \log(S_{t}) \\
    \mu_{Z,t} &amp;= \log( S_{t} ) - \frac{1}{2}\sigma_{Z,t}^2 
\end{align}
</annotation></semantics></math></p>
<p>N.B. if we assume the individual estimates of the incidence are
uncorrelated this simplifies to:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable><mtr><mtd columnalign="right" style="text-align: right"><mo>log</mo><mrow><mo stretchy="true" form="prefix">(</mo><msubsup><mi>σ</mi><mrow><mi>Z</mi><mo>,</mo><mi>t</mi></mrow><mn>2</mn></msubsup><mo stretchy="true" form="postfix">)</mo></mrow></mtd><mtd columnalign="left" style="text-align: left"><mo>=</mo><mo>log</mo><mrow><mo stretchy="true" form="prefix">(</mo><munderover><mo>∑</mo><mrow><mi>τ</mi><mo>=</mo><mn>1</mn></mrow><mrow><mo stretchy="true" form="prefix">|</mo><mi>ω</mi><mo stretchy="true" form="postfix">|</mo></mrow></munderover><msup><mi>e</mi><mrow><mn>2</mn><mo>log</mo><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>T</mi><mrow><mi>t</mi><mo>,</mo><mi>τ</mi></mrow></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow></msup><mo stretchy="true" form="postfix">)</mo></mrow><mo>−</mo><mn>2</mn><mo>log</mo><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>S</mi><mi>t</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow></mtd></mtr></mtable><annotation encoding="application/x-tex">
\begin{align}
\log(\sigma_{Z,t}^2) &amp;= \log(
        \sum_{\tau=1}^{|\omega|} {
          e^{
            2 \log(T_{t,\tau})
          }
        }) - 2 \log(S_{t})
\end{align}
</annotation></semantics></math></p>
<p>Empirically there is not a huge amount of difference in estimates
between these two forms. If the infectivity profile
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>ω</mi><annotation encoding="application/x-tex">\omega</annotation></semantics></math>
is spread out over a large period then the correlation matrix will be
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><msup><mrow><mo stretchy="true" form="prefix">(</mo><mi>ω</mi><mo stretchy="true" form="postfix">)</mo></mrow><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">O(\omega)^2</annotation></semantics></math>
which may predicate this simpler order 1 formulation.</p>
<p>With
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>μ</mi><mrow><mi>Z</mi><mo>,</mo><mi>t</mi></mrow></msub><annotation encoding="application/x-tex">\mu_{Z,t}</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>σ</mi><mrow><mi>Z</mi><mo>,</mo><mi>t</mi></mrow></msub><annotation encoding="application/x-tex">\sigma_{Z,t}</annotation></semantics></math>
we are left with the final derivation of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>R</mi><mi>t</mi></msub><annotation encoding="application/x-tex">R_t</annotation></semantics></math>,
giving us a distributional form of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>R</mi><mi>t</mi></msub><annotation encoding="application/x-tex">R_t</annotation></semantics></math>
incorporating uncertainty from modelled incidence estimates:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable><mtr><mtd columnalign="right" style="text-align: right"><msub><mi>R</mi><mi>t</mi></msub></mtd><mtd columnalign="left" style="text-align: left"><mo>=</mo><mfrac><mrow><mi>L</mi><mi>o</mi><mi>g</mi><mi>n</mi><mi>o</mi><mi>r</mi><mi>m</mi><mi>a</mi><mi>l</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>μ</mi><mi>t</mi></msub><mo>,</mo><msub><mi>σ</mi><mi>t</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><mrow><mi>L</mi><mi>o</mi><mi>g</mi><mi>n</mi><mi>o</mi><mi>r</mi><mi>m</mi><mi>a</mi><mi>l</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>μ</mi><mrow><mi>Z</mi><mo>,</mo><mi>t</mi></mrow></msub><mo>,</mo><msub><mi>σ</mi><mrow><mi>Z</mi><mo>,</mo><mi>t</mi></mrow></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow></mfrac></mtd></mtr><mtr><mtd columnalign="right" style="text-align: right"><msub><mi>μ</mi><msub><mi>R</mi><mi>t</mi></msub></msub></mtd><mtd columnalign="left" style="text-align: left"><mo>=</mo><msub><mi>μ</mi><mi>t</mi></msub><mo>−</mo><msub><mi>μ</mi><mrow><mi>Z</mi><mo>,</mo><mi>t</mi></mrow></msub></mtd></mtr><mtr><mtd columnalign="right" style="text-align: right"><msub><mi>σ</mi><msub><mi>R</mi><mi>t</mi></msub></msub></mtd><mtd columnalign="left" style="text-align: left"><mo>=</mo><msqrt><mrow><msubsup><mi>σ</mi><mi>t</mi><mn>2</mn></msubsup><mo>+</mo><msubsup><mi>σ</mi><mrow><mi>z</mi><mo>,</mo><mi>t</mi></mrow><mn>2</mn></msubsup></mrow></msqrt></mtd></mtr><mtr><mtd columnalign="right" style="text-align: right"><msub><mi>R</mi><mi>t</mi></msub></mtd><mtd columnalign="left" style="text-align: left"><mo>=</mo><mi>L</mi><mi>o</mi><mi>g</mi><mi>n</mi><mi>o</mi><mi>r</mi><mi>m</mi><mi>a</mi><mi>l</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>μ</mi><msub><mi>R</mi><mi>t</mi></msub></msub><mo>,</mo><msub><mi>σ</mi><msub><mi>R</mi><mi>t</mi></msub></msub><mo stretchy="true" form="postfix">)</mo></mrow></mtd></mtr></mtable><annotation encoding="application/x-tex">
\begin{align}
R_t &amp;= \frac{Lognormal(\mu_t,\sigma_t)}
{Lognormal( \mu_{Z,t}, \sigma_{Z,t})} \\
\mu_{R_t} &amp;= \mu_t - \mu_{Z,t} \\
\sigma_{R_t} &amp;= \sqrt{\sigma_t^2+\sigma_{z,t}^2} \\
R_t &amp;= Lognormal(\mu_{R_t}, \sigma_{R_t})
\end{align}
</annotation></semantics></math></p>
<p>This is conditioned on a single known infectivity profile
(<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>ω</mi><annotation encoding="application/x-tex">\omega</annotation></semantics></math>).
In reality there is also uncertainty in the infectivity profile, however
we cannot assume any particular distributional form for this. We can use
a set of empirical estimates of the infectivity profile
(<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>Ω</mi><annotation encoding="application/x-tex">\Omega</annotation></semantics></math>)
to calculate multiple distributional estimates for the reproduction
number
(<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>R</mi><mrow><mi>t</mi><mo>,</mo><mi>ω</mi></mrow></msub><annotation encoding="application/x-tex">R_{t,\omega}</annotation></semantics></math>)
and then combine these as a mixture distribution.</p>
<p>There is not much we can say about this mixture distribution, as it
will depend on the nature of the various empirical infectivity profile
distributions. However, we can use general properties of mixture
distributions to generate estimates for the mean and variance of the
reproduction number including uncertainty arising from multiple
infection profile estimates
(<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msubsup><mi>R</mi><mi>t</mi><mo>*</mo></msubsup><annotation encoding="application/x-tex">R_t^*</annotation></semantics></math>):</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable><mtr><mtd columnalign="right" style="text-align: right"><mi>E</mi><mrow><mo stretchy="true" form="prefix">[</mo><msub><mi>R</mi><mi>t</mi></msub><mo stretchy="false" form="prefix">|</mo><mi>ω</mi><mo stretchy="true" form="postfix">]</mo></mrow></mtd><mtd columnalign="left" style="text-align: left"><mo>=</mo><msup><mi>e</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>μ</mi><mrow><msub><mi>R</mi><mi>t</mi></msub><mo>,</mo><mi>ω</mi></mrow></msub><mo>−</mo><mfrac><mn>1</mn><mn>2</mn></mfrac><msubsup><mi>σ</mi><mrow><msub><mi>R</mi><mi>t</mi></msub><mo>,</mo><mi>ω</mi></mrow><mn>2</mn></msubsup><mo stretchy="true" form="postfix">)</mo></mrow></msup></mtd></mtr><mtr><mtd columnalign="right" style="text-align: right"><mi>V</mi><mrow><mo stretchy="true" form="prefix">[</mo><msub><mi>R</mi><mi>t</mi></msub><mo stretchy="false" form="prefix">|</mo><mi>ω</mi><mo stretchy="true" form="postfix">]</mo></mrow></mtd><mtd columnalign="left" style="text-align: left"><mo>=</mo><mo minsize="1.2" maxsize="1.2" stretchy="false" form="prefix">[</mo><msup><mi>e</mi><mrow><mo stretchy="true" form="prefix">(</mo><msubsup><mi>σ</mi><mrow><msub><mi>R</mi><mi>t</mi></msub><mo>,</mo><mi>ω</mi></mrow><mn>2</mn></msubsup><mo stretchy="true" form="postfix">)</mo></mrow></msup><mo>−</mo><mn>1</mn><mo minsize="1.2" maxsize="1.2" stretchy="false" form="postfix">]</mo><mo minsize="1.2" maxsize="1.2" stretchy="false" form="prefix">[</mo><msup><mi>e</mi><mrow><mn>2</mn><msub><mi>μ</mi><mrow><msub><mi>R</mi><mi>t</mi></msub><mo>,</mo><mi>ω</mi></mrow></msub><mo>+</mo><msubsup><mi>σ</mi><mrow><msub><mi>R</mi><mi>t</mi></msub><mo>,</mo><mi>ω</mi></mrow><mn>2</mn></msubsup></mrow></msup><mo minsize="1.2" maxsize="1.2" stretchy="false" form="postfix">]</mo></mtd></mtr><mtr><mtd columnalign="right" style="text-align: right"><mi>E</mi><mrow><mo stretchy="true" form="prefix">[</mo><msubsup><mi>R</mi><mi>t</mi><mo>*</mo></msubsup><mo stretchy="true" form="postfix">]</mo></mrow></mtd><mtd columnalign="left" style="text-align: left"><mo>=</mo><mfrac><mn>1</mn><mrow><mo stretchy="true" form="prefix">|</mo><mi>Ω</mi><mo stretchy="true" form="postfix">|</mo></mrow></mfrac><munder><mo>∑</mo><mrow><mi>ω</mi><mo>∈</mo><mi>Ω</mi></mrow></munder><mi>E</mi><mrow><mo stretchy="true" form="prefix">[</mo><msub><mi>R</mi><mi>t</mi></msub><mo stretchy="false" form="prefix">|</mo><mi>ω</mi><mo stretchy="true" form="postfix">]</mo></mrow></mtd></mtr><mtr><mtd columnalign="right" style="text-align: right"><mi>V</mi><mrow><mo stretchy="true" form="prefix">[</mo><msubsup><mi>R</mi><mi>t</mi><mo>*</mo></msubsup><mo stretchy="true" form="postfix">]</mo></mrow></mtd><mtd columnalign="left" style="text-align: left"><mo>=</mo><mfrac><mn>1</mn><mrow><mo stretchy="true" form="prefix">|</mo><mi>Ω</mi><mo stretchy="true" form="postfix">|</mo></mrow></mfrac><mo minsize="2.4" maxsize="2.4" stretchy="false" form="prefix">(</mo><munder><mo>∑</mo><mrow><mi>ω</mi><mo>∈</mo><mi>Ω</mi></mrow></munder><mrow><mi>V</mi><mrow><mo stretchy="true" form="prefix">[</mo><msub><mi>R</mi><mi>t</mi></msub><mo stretchy="false" form="prefix">|</mo><mi>ω</mi><mo stretchy="true" form="postfix">]</mo></mrow><mo>+</mo><mi>E</mi><msup><mrow><mo stretchy="true" form="prefix">[</mo><msub><mi>R</mi><mi>t</mi></msub><mo stretchy="false" form="prefix">|</mo><mi>ω</mi><mo stretchy="true" form="postfix">]</mo></mrow><mn>2</mn></msup></mrow><mo minsize="2.4" maxsize="2.4" stretchy="false" form="postfix">)</mo><mo>−</mo><mi>E</mi><msup><mrow><mo stretchy="true" form="prefix">[</mo><msubsup><mi>R</mi><mi>t</mi><mo>*</mo></msubsup><mo stretchy="true" form="postfix">]</mo></mrow><mn>2</mn></msup></mtd></mtr><mtr><mtd columnalign="right" style="text-align: right"></mtd></mtr></mtable><annotation encoding="application/x-tex">
\begin{align}
E[R_t|\omega] &amp;= e^{(\mu_{R_t,\omega} - \frac{1}{2}\sigma_{R_t,\omega}^2)} \\
V[R_t|\omega] &amp;= \big[
  e^{(\sigma_{R_t,\omega}^2)} - 1
\big] \big[
  e^{2 \mu_{R_t,\omega} + \sigma_{R_t,\omega}^2}
\big] \\
E[R_t^*] &amp;= \frac{1}{|\Omega|}\sum_{\omega \in \Omega} E[{R_t|\omega}] \\
V[R_t^*] &amp;= \frac{1}{|\Omega|} \bigg(\sum_{\omega \in \Omega}{V[R_t|\omega]+E[R_t|\omega]^2}\bigg) - E[R_t^*]^2 \\
\end{align}
</annotation></semantics></math></p>
<p>The cumulative distribution function of the mixture is simply the
arithmetic mean of the component cumulative distribution functions
(conditioned on each infectivity profile). If
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>Φ</mi><annotation encoding="application/x-tex">\Phi</annotation></semantics></math>
is the cumulative distribution function of the standard normal
distribution:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable><mtr><mtd columnalign="right" style="text-align: right"><msub><mi>F</mi><msubsup><mi>R</mi><mi>t</mi><mo>*</mo></msubsup></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>x</mi><mo stretchy="true" form="postfix">)</mo></mrow></mtd><mtd columnalign="left" style="text-align: left"><mo>=</mo><mfrac><mn>1</mn><mrow><mo stretchy="true" form="prefix">|</mo><mi>Ω</mi><mo stretchy="true" form="postfix">|</mo></mrow></mfrac><munder><mo>∑</mo><mrow><mi>ω</mi><mo>∈</mo><mi>Ω</mi></mrow></munder><msub><mi>F</mi><msub><mi>R</mi><mi>t</mi></msub></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>x</mi><mo stretchy="false" form="prefix">|</mo><mi>ω</mi><mo stretchy="true" form="postfix">)</mo></mrow></mtd></mtr><mtr><mtd columnalign="right" style="text-align: right"><mi>P</mi><mrow><mo stretchy="true" form="prefix">(</mo><msubsup><mi>R</mi><mi>t</mi><mo>*</mo></msubsup><mo>≤</mo><mi>x</mi><mo stretchy="true" form="postfix">)</mo></mrow></mtd><mtd columnalign="left" style="text-align: left"><mo>=</mo><mfrac><mn>1</mn><mrow><mo stretchy="true" form="prefix">|</mo><mi>Ω</mi><mo stretchy="true" form="postfix">|</mo></mrow></mfrac><munder><mo>∑</mo><mrow><mi>ω</mi><mo>∈</mo><mi>Ω</mi></mrow></munder><mi>P</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>R</mi><mrow><mi>t</mi><mo>,</mo><mi>ω</mi></mrow></msub><mo>≤</mo><mi>x</mi><mo stretchy="true" form="postfix">)</mo></mrow></mtd></mtr><mtr><mtd columnalign="right" style="text-align: right"><mi>P</mi><mrow><mo stretchy="true" form="prefix">(</mo><msubsup><mi>R</mi><mi>t</mi><mo>*</mo></msubsup><mo>≤</mo><mi>x</mi><mo stretchy="true" form="postfix">)</mo></mrow></mtd><mtd columnalign="left" style="text-align: left"><mo>=</mo><mfrac><mn>1</mn><mrow><mo stretchy="true" form="prefix">|</mo><mi>Ω</mi><mo stretchy="true" form="postfix">|</mo></mrow></mfrac><munder><mo>∑</mo><mrow><mi>ω</mi><mo>∈</mo><mi>Ω</mi></mrow></munder><mi>Φ</mi><mo minsize="2.4" maxsize="2.4" stretchy="false" form="prefix">(</mo><mfrac><mrow><mi>l</mi><mi>n</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>x</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>−</mo><msub><mi>μ</mi><mrow><msub><mi>R</mi><mi>t</mi></msub><mo>,</mo><mi>ω</mi></mrow></msub></mrow><msub><mi>σ</mi><mrow><msub><mi>R</mi><mi>t</mi></msub><mo>,</mo><mi>ω</mi></mrow></msub></mfrac><mo minsize="2.4" maxsize="2.4" stretchy="false" form="postfix">)</mo></mtd></mtr></mtable><annotation encoding="application/x-tex">
\begin{align}
F_{R_t^*}(x) &amp;= \frac{1}{|\Omega|}\sum_{\omega \in \Omega}F_{R_t}(x|\omega) \\
P(R_t^* \le x) &amp;= \frac{1}{|\Omega|}\sum_{\omega \in \Omega} P(R_{t,\omega} \le x) \\
P(R_t^* \le x) &amp;= \frac{1}{|\Omega|}\sum_{\omega \in \Omega} \Phi\bigg(\frac{ln(x) - \mu_{R_t,\omega}}{\sigma_{R_t,\omega}}\bigg)
\end{align}
</annotation></semantics></math></p>
<p>As the cumulative density function of this mixture distribution is a
strictly increasing function specific solutions for median and 95%
confidence intervals can be calculated numerically by solving the
following equations:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable><mtr><mtd columnalign="right" style="text-align: right"><mfrac><mn>1</mn><mrow><mo stretchy="true" form="prefix">|</mo><mi>Ω</mi><mo stretchy="true" form="postfix">|</mo></mrow></mfrac><munder><mo>∑</mo><mrow><mi>ω</mi><mo>∈</mo><mi>Ω</mi></mrow></munder><mi>Φ</mi><mo minsize="2.4" maxsize="2.4" stretchy="false" form="prefix">(</mo><mfrac><mrow><mi>l</mi><mi>n</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>q</mi><mn>0.025</mn></msub><mo stretchy="true" form="postfix">)</mo></mrow><mo>−</mo><msub><mi>μ</mi><mrow><msub><mi>R</mi><mi>t</mi></msub><mo>,</mo><mi>ω</mi></mrow></msub></mrow><msub><mi>σ</mi><mrow><msub><mi>R</mi><mi>t</mi></msub><mo>,</mo><mi>ω</mi></mrow></msub></mfrac><mo minsize="2.4" maxsize="2.4" stretchy="false" form="postfix">)</mo><mo>−</mo><mn>0.025</mn></mtd><mtd columnalign="left" style="text-align: left"><mo>=</mo><mn>0</mn></mtd></mtr><mtr><mtd columnalign="right" style="text-align: right"><mfrac><mn>1</mn><mrow><mo stretchy="true" form="prefix">|</mo><mi>Ω</mi><mo stretchy="true" form="postfix">|</mo></mrow></mfrac><munder><mo>∑</mo><mrow><mi>ω</mi><mo>∈</mo><mi>Ω</mi></mrow></munder><mi>Φ</mi><mo minsize="2.4" maxsize="2.4" stretchy="false" form="prefix">(</mo><mfrac><mrow><mi>l</mi><mi>n</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>q</mi><mn>0.5</mn></msub><mo stretchy="true" form="postfix">)</mo></mrow><mo>−</mo><msub><mi>μ</mi><mrow><msub><mi>R</mi><mi>t</mi></msub><mo>,</mo><mi>ω</mi></mrow></msub></mrow><msub><mi>σ</mi><mrow><msub><mi>R</mi><mi>t</mi></msub><mo>,</mo><mi>ω</mi></mrow></msub></mfrac><mo minsize="2.4" maxsize="2.4" stretchy="false" form="postfix">)</mo><mo>−</mo><mn>0.5</mn></mtd><mtd columnalign="left" style="text-align: left"><mo>=</mo><mn>0</mn></mtd></mtr><mtr><mtd columnalign="right" style="text-align: right"><mfrac><mn>1</mn><mrow><mo stretchy="true" form="prefix">|</mo><mi>Ω</mi><mo stretchy="true" form="postfix">|</mo></mrow></mfrac><munder><mo>∑</mo><mrow><mi>ω</mi><mo>∈</mo><mi>Ω</mi></mrow></munder><mi>Φ</mi><mo minsize="2.4" maxsize="2.4" stretchy="false" form="prefix">(</mo><mfrac><mrow><mi>l</mi><mi>n</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>q</mi><mn>0.975</mn></msub><mo stretchy="true" form="postfix">)</mo></mrow><mo>−</mo><msub><mi>μ</mi><mrow><msub><mi>R</mi><mi>t</mi></msub><mo>,</mo><mi>ω</mi></mrow></msub></mrow><msub><mi>σ</mi><mrow><msub><mi>R</mi><mi>t</mi></msub><mo>,</mo><mi>ω</mi></mrow></msub></mfrac><mo minsize="2.4" maxsize="2.4" stretchy="false" form="postfix">)</mo><mo>−</mo><mn>0.975</mn></mtd><mtd columnalign="left" style="text-align: left"><mo>=</mo><mn>0</mn></mtd></mtr></mtable><annotation encoding="application/x-tex">
\begin{align}
\frac{1}{|\Omega|}\sum_{\omega \in \Omega} \Phi\bigg(\frac{ln(q_{0.025}) - \mu_{R_t,\omega}}{\sigma_{R_t,\omega}}\bigg) - 0.025 &amp;= 0 \\
\frac{1}{|\Omega|}\sum_{\omega \in \Omega} \Phi\bigg(\frac{ln(q_{0.5}) - \mu_{R_t,\omega}}{\sigma_{R_t,\omega}}\bigg) - 0.5 &amp;= 0 \\
\frac{1}{|\Omega|}\sum_{\omega \in \Omega} \Phi\bigg(\frac{ln(q_{0.975}) - \mu_{R_t,\omega}}{\sigma_{R_t,\omega}}\bigg) - 0.975 &amp;= 0
\end{align}
</annotation></semantics></math></p>
</div>
<div class="section level2">
<h2 id="implementation">Implementation<a class="anchor" aria-label="anchor" href="#implementation"></a>
</h2>
<p>This method is implemented using the following R function, which is
designed for numerical stability and speed. Generating
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>R</mi><mi>t</mi></msub><annotation encoding="application/x-tex">R_t</annotation></semantics></math>
estimates given modelled incidence typically occurring in a matter of
seconds:</p>
<pre><code><span><span class="co">#&gt; function (mu, sigma, omega, mu_t, sigma_t, cor = FALSE, approx = TRUE) </span></span>
<span><span class="co">#&gt; {</span></span>
<span><span class="co">#&gt;     omega_m = as.matrix(omega)</span></span>
<span><span class="co">#&gt;     omega_m = apply(omega_m, MARGIN = 2, rev)</span></span>
<span><span class="co">#&gt;     tmp = apply(omega_m, MARGIN = 2, function(omega) {</span></span>
<span><span class="co">#&gt;         log_S_t = .logsumexp(mu_t + sigma_t^2/2 + log(omega))</span></span>
<span><span class="co">#&gt;         log_T_t_tau = mu_t + sigma_t^2/2 + log(omega) + log(sigma_t)</span></span>
<span><span class="co">#&gt;         if (cor) {</span></span>
<span><span class="co">#&gt;             n = length(omega)</span></span>
<span><span class="co">#&gt;             idx = 0:(n^2 - 1)</span></span>
<span><span class="co">#&gt;             i = idx%/%n</span></span>
<span><span class="co">#&gt;             j = idx%%n</span></span>
<span><span class="co">#&gt;             log_cor_ij = c(0, log(omega))[abs(i - j) + 1]</span></span>
<span><span class="co">#&gt;             log_var_Zt_ij = log_cor_ij + log_T_t_tau[i + 1] + </span></span>
<span><span class="co">#&gt;                 log_T_t_tau[j + 1]</span></span>
<span><span class="co">#&gt;         }</span></span>
<span><span class="co">#&gt;         else {</span></span>
<span><span class="co">#&gt;             log_var_Zt_ij = 2 * log_T_t_tau</span></span>
<span><span class="co">#&gt;         }</span></span>
<span><span class="co">#&gt;         log_var_Zt = .logsumexp(log_var_Zt_ij) - 2 * log_S_t</span></span>
<span><span class="co">#&gt;         var_Zt = exp(log_var_Zt)</span></span>
<span><span class="co">#&gt;         mu_Zt = log_S_t - var_Zt/2</span></span>
<span><span class="co">#&gt;         mu_Rt = mu - mu_Zt</span></span>
<span><span class="co">#&gt;         var_Rt = sigma^2 + var_Zt</span></span>
<span><span class="co">#&gt;         return(c(mu_Rt, var_Rt))</span></span>
<span><span class="co">#&gt;     })</span></span>
<span><span class="co">#&gt;     mu_Rt = tmp[1, ]</span></span>
<span><span class="co">#&gt;     var_Rt = tmp[2, ]</span></span>
<span><span class="co">#&gt;     sigma_Rt = sqrt(var_Rt)</span></span>
<span><span class="co">#&gt;     means = exp(mu_Rt + var_Rt/2)</span></span>
<span><span class="co">#&gt;     vars = (exp(var_Rt) - 1) * exp(2 * mu_Rt + var_Rt)</span></span>
<span><span class="co">#&gt;     mean_star = mean(means)</span></span>
<span><span class="co">#&gt;     var_star = mean(vars + means^2) - mean_star^2</span></span>
<span><span class="co">#&gt;     out = tibble::tibble(rt.fit = log(mean_star^2/sqrt(mean_star^2 + </span></span>
<span><span class="co">#&gt;         var_star)), rt.se.fit = sqrt(log(1 + var_star/mean_star^2)))</span></span>
<span><span class="co">#&gt;     if (approx) {</span></span>
<span><span class="co">#&gt;         out = out %&gt;% .result_from_fit(type = "rt", qfn = function(p) stats::qlnorm(p, </span></span>
<span><span class="co">#&gt;             .$rt.fit, .$rt.se.fit)) %&gt;% .keep_cdf(type = "rt", </span></span>
<span><span class="co">#&gt;             meanlog = .$rt.fit, sdlog = .$rt.se.fit)</span></span>
<span><span class="co">#&gt;     }</span></span>
<span><span class="co">#&gt;     else {</span></span>
<span><span class="co">#&gt;         out = out %&gt;% .result_from_fit(type = "rt", qfn = function(p) .qmixlnorm(p, </span></span>
<span><span class="co">#&gt;             mu_Rt, sigma_Rt)) %&gt;% .keep_cdf(type = "rt", meanlog = list(mu_Rt), </span></span>
<span><span class="co">#&gt;             sdlog = list(sigma_Rt))</span></span>
<span><span class="co">#&gt;     }</span></span>
<span><span class="co">#&gt;     return(out)</span></span>
<span><span class="co">#&gt; }</span></span>
<span><span class="co">#&gt; &lt;bytecode: 0x62b552ae74e8&gt;</span></span>
<span><span class="co">#&gt; &lt;environment: namespace:ggoutbreak&gt;</span></span></code></pre>
</div>
<div class="section level2">
<h2 id="results">Results<a class="anchor" aria-label="anchor" href="#results"></a>
</h2>
<p>Testing this against the incidence model shown above, and comparing
the results to the SPI-M-O consensus
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>R</mi><mi>t</mi></msub><annotation encoding="application/x-tex">R_t</annotation></semantics></math>
estimates gives us the following time-series for England. This is
formally evaluated elsewhere but qualitatively is a good fit. It took a
few seconds to calculate the reproduction number from this single time
series with 1410 time points , which opens up the possibility of
performing
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>R</mi><mi>t</mi></msub><annotation encoding="application/x-tex">R_t</annotation></semantics></math>
estimates in fine grained geographical or demographic subgroups.</p>
<pre><code><span><span class="co">#&gt;    user  system elapsed </span></span>
<span><span class="co">#&gt;   6.344   0.003   6.347</span></span></code></pre>
<p><img src="rt-from-incidence_files/figure-html/unnamed-chunk-3-1.png" width="700"></p>
</div>
<div class="section level2">
<h2 id="conclusion">Conclusion<a class="anchor" aria-label="anchor" href="#conclusion"></a>
</h2>
<p>We present a methodology for deriving
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>R</mi><mi>t</mi></msub><annotation encoding="application/x-tex">R_t</annotation></semantics></math>
from modelled estimates of incidence while propagating uncertainty. We
demonstrate it produces satisfactory qualitative results against
COVID-19 data. This method is relatively quick, fully deterministic, and
can be used on top of any statistical models for estimating incidence
which use logarithmic link functions.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Robert Challen.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
